<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åŒ¿ååŒ–æ”»å‡»é˜²å¾¡åŸç†æ¼”ç¤ºç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* è“æ©™é…è‰²æ–¹æ¡ˆ */
        :root {
            --color-primary: #2196F3;      /* è“è‰² */
            --color-secondary: #FF9800;    /* æ©™è‰² */
            --color-success: #4CAF50;      /* ç»¿è‰² */
            --color-danger: #f44336;       /* çº¢è‰² */
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            flex: 0 0 65%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .viz-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .viz-box.top {
            flex: 1.5;
            min-height: 400px;
        }
        
        .viz-box.bottom {
            flex: 1;
            min-height: 300px;
        }
        
        .viz-box h3 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .viz-content {
            flex: 1;
            position: relative;
            overflow: auto;
        }
        
        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            flex: 0 0 35%;
            background: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 15px;
        }
        
        .control-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .control-section h3 {
            font-size: 1em;
            color: #555;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        /* é˜¶æ®µé€‰æ‹© */
        .stage-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .stage-tab {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .stage-tab:hover {
            background: #e0e0e0;
        }
        
        .stage-tab.active {
            background: var(--color-primary);
            color: white;
        }
        
        /* æ–¹æ³•é€‰æ‹© */
        .method-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .method-btn {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            text-align: left;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: var(--color-primary);
            background: #e3f2fd;
        }
        
        .method-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        /* åŸç†è¯´æ˜ */
        .principle-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-size: 0.85em;
            line-height: 1.6;
        }
        
        .formula {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 3px solid var(--color-primary);
        }
        
        /* æ­¥éª¤åˆ—è¡¨ */
        .step-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .step-item {
            padding: 10px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #e0e0e0;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .step-item:hover {
            background: #e8f5e9;
        }
        
        .step-item.active {
            background: #e3f2fd;
            border-left-color: var(--color-primary);
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .ctrl-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .ctrl-btn.play {
            background: var(--color-primary);
            color: white;
        }
        
        .ctrl-btn.play:hover {
            background: #1976D2;
        }
        
        .ctrl-btn.reset {
            background: #e0e0e0;
        }
        
        .ctrl-btn.reset:hover {
            background: #bdbdbd;
        }
        
        /* å›¾å¯è§†åŒ–æ ·å¼ */
        svg {
            width: 100%;
            height: 100%;
        }
        
        .node {
            stroke: white;
            stroke-width: 2px;
            cursor: pointer;
        }
        
        .node.highlighted {
            stroke: var(--color-secondary);
            stroke-width: 4px;
            animation: pulse 1s infinite;
        }
        
        .node.matched {
            stroke: var(--color-success);
            stroke-width: 4px;
        }
        
        .node:hover {
            stroke: var(--color-secondary);
            stroke-width: 3px;
            cursor: pointer;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        
        .link.highlighted {
            stroke: var(--color-secondary);
            stroke-width: 3px;
            stroke-opacity: 1;
            animation: dash 1s linear infinite;
        }
        
        .link.matched {
            stroke: var(--color-success);
            stroke-width: 3px;
            stroke-opacity: 1;
        }
        
        @keyframes pulse {
            0%, 100% { stroke-width: 4px; opacity: 1; }
            50% { stroke-width: 6px; opacity: 0.7; }
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
        
        /* è¿æ¥çº¿åŠ¨ç”» */
        .match-line {
            stroke: var(--color-success);
            stroke-width: 2px;
            stroke-dasharray: 5,5;
            opacity: 0.8;
            animation: dash 0.5s linear infinite;
        }
        
        /* èŠ‚ç‚¹æ ‡ç­¾ */
        .node-label {
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
        }
        
        /* æç¤ºæ¡† */
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        
        /* çŸ©é˜µæ ·å¼ */
        .matrix-container {
            display: grid;
            gap: 2px;
            padding: 10px;
        }
        
        .matrix-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .matrix-cell:hover {
            transform: scale(1.15);
            z-index: 10;
        }
        
        .matrix-cell.selected {
            transform: scale(1.2);
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.6);
            border: 3px solid var(--color-secondary);
            z-index: 20;
            animation: glow 1s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 152, 0, 0.6); }
            50% { box-shadow: 0 6px 30px rgba(255, 152, 0, 0.9); }
        }
        
        /* å›¾è¡¨æ ·å¼ */
        .chart-line {
            fill: none;
            stroke: var(--color-primary);
            stroke-width: 2px;
        }
        
        .chart-point {
            fill: var(--color-primary);
            stroke: white;
            stroke-width: 2px;
        }
        
        .axis {
            font-size: 11px;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--color-primary);
        }
        
        /* å›¾å¯¹æ¯”å®¹å™¨ */
        .graph-container {
            display: flex;
            gap: 15px;
            height: 100%;
        }
        
        .graph-item {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .graph-item h4 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§ï¼šå›¾å’ŒçŸ©é˜µ -->
        <div class="left-panel">
            <div class="viz-box top">
                <h3 id="top-title">å›¾å¯è§†åŒ–å¯¹æ¯”</h3>
                <div class="viz-content" id="top-viz">
                    <div class="graph-container">
                        <div class="graph-item">
                            <h4>åŸå§‹å›¾</h4>
                            <svg id="graph-orig-svg"></svg>
                        </div>
                        <div class="graph-item">
                            <h4>åŒ¿åå›¾</h4>
                            <svg id="graph-anon-svg"></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div class="viz-box bottom">
                <h3 id="bottom-title">çŸ©é˜µ/æ•°æ®å¯è§†åŒ–</h3>
                <div class="viz-content" id="bottom-viz"></div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <!-- é˜¶æ®µé€‰æ‹© -->
            <div class="control-section">
                <h3>æ”»å‡»é˜¶æ®µ</h3>
                <div class="stage-tabs">
                    <button class="stage-tab active" data-stage="1">é˜¶æ®µä¸€<br>èº«ä»½å»åŒ¿ååŒ–</button>
                    <button class="stage-tab" data-stage="2">é˜¶æ®µäºŒ<br>å±æ€§æ¨æ–­</button>
                    <button class="stage-tab" data-stage="3">é˜¶æ®µä¸‰<br>é˜²å¾¡æ–¹æ³•</button>
                </div>
            </div>
            
            <!-- æ–¹æ³•é€‰æ‹© -->
            <div class="control-section">
                <h3>æ”»å‡»/é˜²å¾¡æ–¹æ³•</h3>
                <div class="method-selector" id="method-selector"></div>
            </div>
            
            <!-- åŸç†è¯´æ˜ -->
            <div class="control-section">
                <h3>åŸç†è¯´æ˜</h3>
                <div class="principle-box" id="principle-content">
                    è¯·é€‰æ‹©ä¸€ä¸ªæ–¹æ³•æŸ¥çœ‹åŸç†
                </div>
            </div>
            
            <!-- æ­¥éª¤è¯¦æƒ… -->
            <div class="control-section">
                <h3>æ¼”ç¤ºæ­¥éª¤</h3>
                <div class="step-list" id="step-list">
                    <div class="step-item">è¯·é€‰æ‹©ä¸€ä¸ªæ–¹æ³•</div>
                </div>
                <div class="controls">
                    <button class="ctrl-btn play" id="play-btn">â–¶ï¸ æ’­æ”¾</button>
                    <button class="ctrl-btn reset" id="reset-btn">ğŸ”„ é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let DATA = null;
        let currentStage = 1;
        let currentMethod = null;
        let currentStep = 0;
        let isPlaying = false;
        let playInterval = null;
        
        // å…¨å±€å¯è§†åŒ–å¯¹è±¡
        let origGraphSim = null;
        let anonGraphSim = null;
        let origGraphElements = null;
        let anonGraphElements = null;
        
        // åŠ è½½æ•°æ®
        d3.json('all_stages_demo_data.json').then(data => {
            DATA = data;
            console.log('æ•°æ®åŠ è½½æˆåŠŸ:', data);
            initializeUI();
        }).catch(err => {
            console.error('æ•°æ®åŠ è½½å¤±è´¥:', err);
            alert('æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ all_stages_demo_data.json å­˜åœ¨ï¼');
        });
        
        function initializeUI() {
            // é˜¶æ®µåˆ‡æ¢
            d3.selectAll('.stage-tab').on('click', function() {
                const stage = parseInt(this.dataset.stage);
                selectStage(stage);
            });
            
            // æ’­æ”¾æŒ‰é’®
            d3.select('#play-btn').on('click', togglePlay);
            
            // é‡ç½®æŒ‰é’®
            d3.select('#reset-btn').on('click', resetDemo);
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé˜¶æ®µ
            selectStage(1);
        }
        
        function selectStage(stage) {
            currentStage = stage;
            currentMethod = null;
            currentStep = 0;
            isPlaying = false;
            clearInterval(playInterval);
            
            d3.selectAll('.stage-tab').classed('active', false);
            d3.select(`.stage-tab[data-stage="${stage}"]`).classed('active', true);
            
            renderMethodButtons();
        }
        
        function renderMethodButtons() {
            const methodSelector = d3.select('#method-selector');
            methodSelector.html('');
            
            let methods = [];
            if (currentStage === 1) {
                methods = [
                    {id: 'greedy', name: 'è´ªå¿ƒç‰¹å¾åŒ¹é…'},
                    {id: 'hungarian', name: 'åŒˆç‰™åˆ©ç®—æ³•'},
                    {id: 'graph_kernel', name: 'å›¾æ ¸æ–¹æ³•'},
                    {id: 'deepwalk', name: 'DeepWalkåµŒå…¥'}
                ];
            } else if (currentStage === 2) {
                methods = [
                    {id: 'neighbor_voting', name: 'é‚»å±…æŠ•ç¥¨'},
                    {id: 'label_propagation', name: 'æ ‡ç­¾ä¼ æ’­'},
                    {id: 'graphsage', name: 'GraphSAGE'}
                ];
            } else if (currentStage === 3) {
                methods = [
                    {id: 'differential_privacy', name: 'å·®åˆ†éšç§é˜²å¾¡'},
                    {id: 'k_anonymity', name: 'k-åŒ¿ååŒ–'},
                    {id: 'edge_perturbation', name: 'è¾¹æ‰°åŠ¨é˜²å¾¡'}
                ];
            }
            
            methods.forEach((method, i) => {
                methodSelector.append('button')
                    .attr('class', 'method-btn')
                    .attr('data-method', method.id)
                    .text(method.name)
                    .on('click', () => selectMethod(method.id));
            });
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ–¹æ³•
            if (methods.length > 0) {
                selectMethod(methods[0].id);
            }
        }
        
        function selectMethod(methodId) {
            currentMethod = methodId;
            currentStep = 0;
            isPlaying = false;
            clearInterval(playInterval);
            
            d3.selectAll('.method-btn').classed('active', false);
            d3.select(`.method-btn[data-method="${methodId}"]`).classed('active', true);
            
            loadMethodData();
        }
        
        function loadMethodData() {
            if (!DATA) return;
            
            if (currentStage === 1) {
                if (currentMethod === 'greedy') loadGreedy();
                else if (currentMethod === 'hungarian') loadHungarian();
                else if (currentMethod === 'graph_kernel') loadGraphKernel();
                else if (currentMethod === 'deepwalk') loadDeepWalk();
            } else if (currentStage === 2) {
                if (currentMethod === 'neighbor_voting') loadNeighborVoting();
                else if (currentMethod === 'label_propagation') loadLabelPropagation();
                else if (currentMethod === 'graphsage') loadGraphSAGE();
            } else if (currentStage === 3) {
                if (currentMethod === 'differential_privacy') loadDifferentialPrivacy();
                else if (currentMethod === 'k_anonymity') loadKAnonymity();
                else if (currentMethod === 'edge_perturbation') loadEdgePerturbation();
            }
        }
        
        // ==================== ç¬¬ä¸€é˜¶æ®µï¼šèº«ä»½å»åŒ¿ååŒ– ====================
        
        function loadGreedy() {
            const data = DATA.stage1.greedy;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = 'ç›¸ä¼¼åº¦çŸ©é˜µ';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. è®¡ç®—èŠ‚ç‚¹ç‰¹å¾å‘é‡<br>
   f(v) = [åº¦, èšç±»ç³»æ•°, ä¸‰è§’å½¢æ•°, ...]
                </div>
                <div class="formula">
2. è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ<br>
   S[i,j] = cosine_similarity(f(v_i), f(v'_j))
                </div>
                <div class="formula">
3. è´ªå¿ƒé€‰æ‹©æœ€å¤§ç›¸ä¼¼åº¦è¿›è¡ŒåŒ¹é…<br>
   é‡å¤ç›´åˆ°æ‰€æœ‰èŠ‚ç‚¹åŒ¹é…å®Œæˆ
                </div>
            `;
            
            renderTwoGraphs();
            renderSimilarityMatrix(data);
            loadGreedySteps(data);
        }
        
        function renderSimilarityMatrix(data) {
            const container = document.getElementById('bottom-viz');
            const matrix = data.similarity_matrix;
            const n = matrix.length;
            
            container.innerHTML = '';
            const matrixDiv = document.createElement('div');
            matrixDiv.className = 'matrix-container';
            matrixDiv.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
            
            matrix.forEach((row, i) => {
                row.forEach((val, j) => {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.style.background = getHeatColor(val);
                    cell.style.color = val > 0.5 ? 'white' : 'black';
                    cell.textContent = val.toFixed(2);
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.onmouseover = () => {
                        // é«˜äº®å¯¹åº”çš„å›¾èŠ‚ç‚¹
                        if (origGraphElements && anonGraphElements) {
                            origGraphElements.nodes.classed('highlighted', d => d.index === i);
                            anonGraphElements.nodes.classed('highlighted', d => d.index === j);
                        }
                    };
                    cell.onmouseout = () => {
                        if (origGraphElements && anonGraphElements) {
                            origGraphElements.nodes.classed('highlighted', false);
                            anonGraphElements.nodes.classed('highlighted', false);
                        }
                    };
                    cell.onclick = () => highlightMatrixCell(i, j);
                    matrixDiv.appendChild(cell);
                });
            });
            
            container.appendChild(matrixDiv);
        }
        
        function getHeatColor(value) {
            // è“è‰²(ä½) -> æ©™è‰²(é«˜)
            if (value < 0.5) {
                // è“è‰²èŒƒå›´
                const t = value * 2;
                const r = Math.floor(33 + t * 188);
                const g = Math.floor(150 + t * 102);
                const b = Math.floor(243 - t * 91);
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                // æ©™è‰²èŒƒå›´
                const t = (value - 0.5) * 2;
                const r = Math.floor(221 + t * 34);
                const g = Math.floor(252 - t * 104);
                const b = Math.floor(152 - t * 152);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
        
        function highlightMatrixCell(i, j) {
            d3.selectAll('.matrix-cell').classed('selected', false);
            const cells = document.querySelectorAll('.matrix-cell');
            cells.forEach(cell => {
                if (parseInt(cell.dataset.row) === i && parseInt(cell.dataset.col) === j) {
                    cell.classList.add('selected');
                }
            });
            
            // é«˜äº®å¯¹åº”çš„å›¾èŠ‚ç‚¹
            if (origGraphElements && anonGraphElements) {
                origGraphElements.nodes
                    .classed('highlighted', d => d.index === i)
                    .classed('matched', d => d.index === i);
                anonGraphElements.nodes
                    .classed('highlighted', d => d.index === j)
                    .classed('matched', d => d.index === j);
            }
        }
        
        function loadGreedySteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.steps.forEach((step, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `æ­¥éª¤ ${idx + 1}: åŒ¹é…èŠ‚ç‚¹ ${step.orig_node} â†’ ${step.anon_node} (ç›¸ä¼¼åº¦: ${step.similarity.toFixed(3)})`;
                stepItem.onclick = () => {
                    selectStep(idx);
                    animateGreedyMatch(data, idx);
                };
                stepList.appendChild(stepItem);
            });
        }
        
        // è´ªå¿ƒåŒ¹é…åŠ¨ç”»
        function animateGreedyMatch(data, stepIdx) {
            const step = data.steps[stepIdx];
            
            // é«˜äº®èŠ‚ç‚¹
            if (origGraphElements && anonGraphElements) {
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                origGraphElements.nodes.classed('highlighted', false).classed('matched', false);
                anonGraphElements.nodes.classed('highlighted', false).classed('matched', false);
                
                // é«˜äº®å½“å‰åŒ¹é…çš„èŠ‚ç‚¹
                origGraphElements.nodes
                    .filter(d => d.index === step.orig_node)
                    .classed('highlighted', true);
                    
                anonGraphElements.nodes
                    .filter(d => d.index === step.anon_node)
                    .classed('highlighted', true);
                
                // æ ‡è®°å·²åŒ¹é…çš„èŠ‚ç‚¹
                data.steps.slice(0, stepIdx + 1).forEach(s => {
                    origGraphElements.nodes
                        .filter(d => d.index === s.orig_node)
                        .classed('matched', true);
                    anonGraphElements.nodes
                        .filter(d => d.index === s.anon_node)
                        .classed('matched', true);
                });
            }
            
            // é«˜äº®çŸ©é˜µå•å…ƒæ ¼
            highlightMatrixCell(step.orig_node, step.anon_node);
        }
        
        function loadHungarian() {
            const data = DATA.stage1.hungarian;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = 'æˆæœ¬çŸ©é˜µï¼ˆåŒˆç‰™åˆ©ç®—æ³•ï¼‰';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. è½¬æ¢ä¸ºæˆæœ¬çŸ©é˜µ: C = -S
                </div>
                <div class="formula">
2. è¡Œå½’çº¦: æ¯è¡Œå‡å»æœ€å°å€¼
                </div>
                <div class="formula">
3. åˆ—å½’çº¦: æ¯åˆ—å‡å»æœ€å°å€¼
                </div>
                <div class="formula">
4. æ±‚è§£æœ€ä¼˜åŒ¹é…
                </div>
            `;
            
            renderTwoGraphs();
            renderCostMatrix(data, 0);
            loadHungarianSteps(data);
        }
        
        function renderCostMatrix(data, stepIdx) {
            const container = document.getElementById('bottom-viz');
            const matrix = data.steps[stepIdx].cost_matrix;
            const n = matrix.length;
            
            container.innerHTML = '';
            const matrixDiv = document.createElement('div');
            matrixDiv.className = 'matrix-container';
            matrixDiv.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
            
            matrix.forEach((row, i) => {
                row.forEach((val, j) => {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.style.background = getCostColor(val);
                    cell.style.color = 'white';
                    cell.textContent = val.toFixed(2);
                    matrixDiv.appendChild(cell);
                });
            });
            
            container.appendChild(matrixDiv);
        }
        
        function getCostColor(value) {
            // æˆæœ¬: è“è‰²(ä½/å¥½) -> æ©™è‰²(é«˜/å·®)
            const normalized = (value + 1) / 2;
            if (normalized < 0.5) {
                const t = normalized * 2;
                const r = Math.floor(33 + t * 188);
                const g = Math.floor(150 + t * 102);
                const b = Math.floor(243 - t * 91);
                return `rgb(${r}, ${g}, ${b})`;
            } else {
                const t = (normalized - 0.5) * 2;
                const r = Math.floor(221 + t * 34);
                const g = Math.floor(252 - t * 104);
                const b = Math.floor(152 - t * 152);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }
        
        function loadHungarianSteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.steps.forEach((step, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `${step.description}`;
                stepItem.onclick = () => {
                    selectStep(idx);
                    renderCostMatrix(data, idx);
                    if (step.matched_pairs) {
                        animateHungarianMatches(step.matched_pairs);
                    }
                };
                stepList.appendChild(stepItem);
            });
        }
        
        // åŒˆç‰™åˆ©ç®—æ³•åŒ¹é…åŠ¨ç”»
        function animateHungarianMatches(matchedPairs) {
            if (!origGraphElements || !anonGraphElements) return;
            
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            origGraphElements.nodes.classed('highlighted', false).classed('matched', false);
            anonGraphElements.nodes.classed('highlighted', false).classed('matched', false);
            
            // é€ä¸ªæ˜¾ç¤ºåŒ¹é…
            matchedPairs.forEach((pair, idx) => {
                setTimeout(() => {
                    origGraphElements.nodes
                        .filter(d => d.index === pair[0])
                        .classed('matched', true);
                    anonGraphElements.nodes
                        .filter(d => d.index === pair[1])
                        .classed('matched', true);
                }, idx * 300);
            });
        }
        
        function loadGraphKernel() {
            const data = DATA.stage1.graph_kernel;
            
            document.getElementById('top-title').textContent = 'å­å›¾å¯è§†åŒ–ç¤ºä¾‹';
            document.getElementById('bottom-title').textContent = 'WLæ ¸è¿­ä»£è¿‡ç¨‹';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. æå–å±€éƒ¨å­å›¾ç»“æ„
                </div>
                <div class="formula">
2. WLæ ¸è¿­ä»£æ›´æ–°æ ‡ç­¾<br>
   label'(v) = hash(label(v) + sort([label(u) for u in N(v)]))
                </div>
                <div class="formula">
3. è®¡ç®—æ ‡ç­¾åˆ†å¸ƒç›¸ä¼¼åº¦
                </div>
            `;
            
            renderSubgraph(data);
            renderWLIterations(data, 0);
            loadGraphKernelSteps(data);
        }
        
        function renderSubgraph(data) {
            const container = document.getElementById('top-viz');
            container.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%;"><svg id="subgraph-svg" style="width: 60%; height: 90%;"></svg></div>';
            
            const svg = d3.select('#subgraph-svg');
            const svgNode = svg.node();
            const width = svgNode.clientWidth;
            const height = svgNode.clientHeight;
            
            const simulation = d3.forceSimulation(data.subgraph.nodes)
                .force('link', d3.forceLink(data.subgraph.links).id(d => d.id).distance(50))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width/2, height/2));
            
            const link = svg.append('g')
                .selectAll('line')
                .data(data.subgraph.links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', 2);
            
            const node = svg.append('g')
                .selectAll('circle')
                .data(data.subgraph.nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', d => d.type === 'center' ? 15 : 10)
                .attr('fill', d => d.type === 'center' ? '#FF9800' : '#2196F3')
                .on('mouseover', function(event, d) {
                    d3.select(this).classed('highlighted', true);
                    // é«˜äº®ç›¸è¿çš„è¾¹
                    link.classed('highlighted', l => 
                        l.source.id === d.id || l.target.id === d.id
                    );
                    showTooltip(event, `èŠ‚ç‚¹ ${d.id}<br>ç±»å‹: ${d.type === 'center' ? 'ä¸­å¿ƒèŠ‚ç‚¹' : 'é‚»å±…èŠ‚ç‚¹'}`);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).classed('highlighted', false);
                    link.classed('highlighted', false);
                    hideTooltip();
                });
            
            // æ·»åŠ æ ‡ç­¾
            const labels = svg.append('g')
                .selectAll('text')
                .data(data.subgraph.nodes)
                .join('text')
                .attr('class', 'node-label')
                .attr('dy', '0.35em')
                .text(d => d.id);
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            setTimeout(() => simulation.stop(), 2000);
        }
        
        function renderWLIterations(data, stepIdx) {
            const container = document.getElementById('bottom-viz');
            const step = data.wl_iterations[stepIdx];
            
            container.innerHTML = `
                <div class="stats-box">
                    <h4>WLæ ¸è¿­ä»£ ${stepIdx}</h4>
                    <div class="stat-item">
                        <strong>èŠ‚ç‚¹æ ‡ç­¾:</strong><br>
                        ${JSON.stringify(step.labels, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;')}
                    </div>
                    <div class="stat-item">
                        ç›¸ä¼¼åº¦: <span class="stat-value">${step.similarity.toFixed(3)}</span>
                    </div>
                    <div class="stat-item">
                        <small>ğŸ’¡ æ¯æ¬¡è¿­ä»£æ ¹æ®é‚»å±…æ ‡ç­¾æ›´æ–°èŠ‚ç‚¹æ ‡ç­¾</small>
                    </div>
                </div>
            `;
        }
        
        function loadGraphKernelSteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.wl_iterations.forEach((step, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `è¿­ä»£ ${idx}: ç›¸ä¼¼åº¦ ${step.similarity.toFixed(3)}`;
                stepItem.onclick = () => {
                    selectStep(idx);
                    renderWLIterations(data, idx);
                };
                stepList.appendChild(stepItem);
            });
        }
        
        function loadDeepWalk() {
            const data = DATA.stage1.deepwalk;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = '2DåµŒå…¥ç©ºé—´';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. éšæœºæ¸¸èµ°é‡‡æ ·è·¯å¾„
                </div>
                <div class="formula">
2. Skip-gramæ¨¡å‹è®­ç»ƒåµŒå…¥
                </div>
                <div class="formula">
3. åœ¨åµŒå…¥ç©ºé—´ä¸­åŒ¹é…èŠ‚ç‚¹
                </div>
            `;
            
            renderTwoGraphs();
            renderEmbedding(data);
            loadDeepWalkSteps(data);
        }
        
        function renderEmbedding(data) {
            const container = document.getElementById('bottom-viz');
            container.innerHTML = '<svg id="embedding-svg"></svg>';
            
            const svg = d3.select('#embedding-svg');
            const svgNode = svg.node();
            const width = svgNode.clientWidth || 500;
            const height = svgNode.clientHeight || 400;
            const margin = {top: 20, right: 20, bottom: 40, left: 40};
            
            const xExtent = d3.extent([...data.orig_embedding.map(d => d[0]), ...data.anon_embedding.map(d => d[0])]);
            const yExtent = d3.extent([...data.orig_embedding.map(d => d[1]), ...data.anon_embedding.map(d => d[1])]);
            
            const xScale = d3.scaleLinear()
                .domain(xExtent)
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([height - margin.bottom, margin.top]);
            
            const points = [
                ...data.orig_embedding.map((d, i) => ({x: d[0], y: d[1], type: 'orig', id: i})),
                ...data.anon_embedding.map((d, i) => ({x: d[0], y: d[1], type: 'anon', id: i}))
            ];
            
            svg.selectAll('circle')
                .data(points)
                .join('circle')
                .attr('cx', d => xScale(d.x))
                .attr('cy', d => yScale(d.y))
                .attr('r', 5)
                .attr('fill', d => d.type === 'orig' ? '#2196F3' : '#FF9800')
                .attr('opacity', 0.7)
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .attr('class', 'node')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 8).attr('opacity', 1);
                    showTooltip(event, `${d.type === 'orig' ? 'åŸå§‹' : 'åŒ¿å'}å›¾èŠ‚ç‚¹ ${d.id}<br>åæ ‡: (${d.x.toFixed(2)}, ${d.y.toFixed(2)})`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 5).attr('opacity', 0.7);
                    hideTooltip();
                });
            
            // ç»˜åˆ¶åŒ¹é…è¿çº¿ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.matches) {
                data.matches.slice(0, 5).forEach(match => {
                    const origPoint = points.find(p => p.type === 'orig' && p.id === match.orig);
                    const anonPoint = points.find(p => p.type === 'anon' && p.id === match.anon);
                    if (origPoint && anonPoint) {
                        svg.append('line')
                            .attr('class', 'match-line')
                            .attr('x1', xScale(origPoint.x))
                            .attr('y1', yScale(origPoint.y))
                            .attr('x2', xScale(anonPoint.x))
                            .attr('y2', yScale(anonPoint.y));
                    }
                });
            }
            
            // å›¾ä¾‹
            const legend = svg.append('g').attr('transform', `translate(${width-100}, 20)`);
            legend.append('circle').attr('r', 5).attr('fill', '#2196F3');
            legend.append('text').attr('x', 10).attr('y', 5).text('åŸå§‹å›¾').attr('font-size', 11);
            legend.append('circle').attr('cy', 20).attr('r', 5).attr('fill', '#FF9800');
            legend.append('text').attr('x', 10).attr('y', 25).text('åŒ¿åå›¾').attr('font-size', 11);
        }
        
        function loadDeepWalkSteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.matches.forEach((match, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `åŒ¹é… ${match.orig} â†’ ${match.anon} (è·ç¦»: ${match.distance.toFixed(3)})`;
                stepItem.onclick = () => selectStep(idx);
                stepList.appendChild(stepItem);
            });
        }
        
        // ==================== ç¬¬äºŒé˜¶æ®µï¼šå±æ€§æ¨æ–­ ====================
        
        function loadNeighborVoting() {
            const data = DATA.stage2.neighbor_voting;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = 'é‚»å±…æŠ•ç¥¨ç»“æœ';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. æ”¶é›†é‚»å±…çš„å·²çŸ¥æ ‡ç­¾
                </div>
                <div class="formula">
2. æŠ•ç¥¨é€‰æ‹©å¤šæ•°æ ‡ç­¾
                </div>
                <div class="formula">
3. é¢„æµ‹æœªçŸ¥èŠ‚ç‚¹çš„æ ‡ç­¾
                </div>
            `;
            
            renderTwoGraphs();
            renderVotingResult(data, 0);
            loadNeighborVotingSteps(data);
        }
        
        function renderVotingResult(data, stepIdx) {
            const container = document.getElementById('bottom-viz');
            const step = data.steps[stepIdx];
            
            // åˆ›å»ºå¯è§†åŒ–æŠ•ç¥¨è¿‡ç¨‹
            let votesHtml = '<div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0;">';
            for (const [label, count] of Object.entries(step.votes)) {
                const percentage = (count / Object.values(step.votes).reduce((a, b) => a + b, 0)) * 100;
                votesHtml += `
                    <div style="flex: 1; min-width: 80px;">
                        <div style="background: ${label === step.predicted_label ? '#4CAF50' : '#e0e0e0'}; 
                                    height: ${percentage}px; border-radius: 4px; transition: all 0.3s;"></div>
                        <div style="text-align: center; margin-top: 5px;">
                            <strong>${label}</strong><br>
                            <small>${count}ç¥¨</small>
                        </div>
                    </div>
                `;
            }
            votesHtml += '</div>';
            
            container.innerHTML = `
                <div class="stats-box">
                    <h4>èŠ‚ç‚¹ ${step.node} çš„æŠ•ç¥¨ç»“æœ</h4>
                    <div class="stat-item">
                        <strong>é‚»å±…æŠ•ç¥¨åˆ†å¸ƒ:</strong>
                        ${votesHtml}
                    </div>
                    <div class="stat-item">
                        é¢„æµ‹æ ‡ç­¾: <span class="stat-value" style="font-size: 1.2em;">âœ“ ${step.predicted_label}</span>
                    </div>
                </div>
            `;
        }
        
        function loadNeighborVotingSteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.steps.forEach((step, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `èŠ‚ç‚¹ ${step.node}: é¢„æµ‹ ${step.predicted_label}`;
                stepItem.onclick = () => {
                    selectStep(idx);
                    renderVotingResult(data, idx);
                };
                stepList.appendChild(stepItem);
            });
        }
        
        function loadLabelPropagation() {
            const data = DATA.stage2.label_propagation;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = 'æ ‡ç­¾ä¼ æ’­è¿‡ç¨‹';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
è¿­ä»£ä¼ æ’­æ ‡ç­¾åˆ°é‚»å±…èŠ‚ç‚¹<br>
ç›´åˆ°æ”¶æ•›
                </div>
            `;
            
            renderTwoGraphs();
            renderLabelPropResult(data, 0);
            loadLabelPropSteps(data);
        }
        
        function renderLabelPropResult(data, iterIdx) {
            const container = document.getElementById('bottom-viz');
            const iter = data.iterations[iterIdx];
            
            // åˆ›å»ºæ ‡ç­¾åˆ†å¸ƒçš„å¯è§†åŒ–
            let distHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 10px 0;">';
            for (const [label, count] of Object.entries(iter.label_distribution)) {
                distHtml += `
                    <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                        <div style="font-size: 1.5em; color: var(--color-primary);">${count}</div>
                        <div style="font-size: 0.85em;">æ ‡ç­¾ ${label}</div>
                    </div>
                `;
            }
            distHtml += '</div>';
            
            container.innerHTML = `
                <div class="stats-box">
                    <h4>è¿­ä»£ ${iterIdx} ${iter.converged ? 'âœ“ å·²æ”¶æ•›' : 'â³ è¿›è¡Œä¸­'}</h4>
                    <div class="stat-item">
                        æ”¶æ•›çŠ¶æ€: <span class="stat-value">${iter.converged ? 'æ˜¯' : 'å¦'}</span>
                    </div>
                    <div class="stat-item">
                        <strong>æ ‡ç­¾åˆ†å¸ƒ:</strong>
                        ${distHtml}
                    </div>
                    <div class="stat-item">
                        <small>ğŸ’¡ æ ‡ç­¾ä»å·²çŸ¥èŠ‚ç‚¹ä¼ æ’­åˆ°æœªçŸ¥èŠ‚ç‚¹</small>
                    </div>
                </div>
            `;
        }
        
        function loadLabelPropSteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '';
            
            data.iterations.forEach((iter, idx) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item' + (idx === 0 ? ' active' : '');
                stepItem.textContent = `è¿­ä»£ ${idx}: ${iter.converged ? 'æ”¶æ•›' : 'è¿›è¡Œä¸­'}`;
                stepItem.onclick = () => {
                    selectStep(idx);
                    renderLabelPropResult(data, idx);
                };
                stepList.appendChild(stepItem);
            });
        }
        
        function loadGraphSAGE() {
            const data = DATA.stage2.graphsage;
            
            document.getElementById('top-title').textContent = 'å›¾å¯è§†åŒ–å¯¹æ¯”ï¼ˆåŸå§‹å›¾ vs åŒ¿åå›¾ï¼‰';
            document.getElementById('bottom-title').textContent = 'GraphSAGEè¯´æ˜';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
é‡‡æ ·é‚»å±… â†’ èšåˆç‰¹å¾ â†’ æ›´æ–°èŠ‚ç‚¹è¡¨ç¤º
                </div>
            `;
            
            renderTwoGraphs();
            document.getElementById('bottom-viz').innerHTML = 
                `<div class="stats-box"><p>${data.description}</p></div>`;
            loadGraphSAGESteps(data);
        }
        
        function loadGraphSAGESteps(data) {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '<div class="step-item active">æŸ¥çœ‹GraphSAGEè¯´æ˜</div>';
        }
        
        // ==================== ç¬¬ä¸‰é˜¶æ®µï¼šé˜²å¾¡æ–¹æ³• ====================
        
        function loadDifferentialPrivacy() {
            const data = DATA.stage3.defense;
            
            document.getElementById('top-title').textContent = 'å·®åˆ†éšç§é˜²å¾¡æ•ˆæœ';
            document.getElementById('bottom-title').textContent = 'é˜²å¾¡å‚æ•°åˆ†æ';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
æ·»åŠ æ»¡è¶³Îµ-å·®åˆ†éšç§çš„å™ªå£°è¾¹<br>
Îµè¶Šå°ï¼Œéšç§ä¿æŠ¤è¶Šå¼º
                </div>
                <div class="formula">
Pr[M(D) âˆˆ S] â‰¤ e^Îµ Â· Pr[M(D') âˆˆ S]
                </div>
            `;
            
            renderDefenseChart(data);
            renderDefenseTable(data);
            loadDefenseSteps();
        }
        
        function loadKAnonymity() {
            document.getElementById('top-title').textContent = 'k-åŒ¿ååŒ–é˜²å¾¡';
            document.getElementById('bottom-title').textContent = 'k-åŒ¿ååŒ–è¯´æ˜';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘ä¸k-1ä¸ª<br>
å…¶ä»–èŠ‚ç‚¹ä¸å¯åŒºåˆ†
                </div>
            `;
            
            renderTwoGraphs();
            document.getElementById('bottom-viz').innerHTML = 
                `<div class="stats-box">
                    <h4>k-åŒ¿ååŒ–åŸç†</h4>
                    <p>é€šè¿‡ä¿®æ”¹å›¾ç»“æ„ï¼Œä½¿å¾—ä»»ä½•kä¸ªèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„ç»“æ„ç‰¹å¾ï¼Œä»è€Œä¿æŠ¤ä¸ªä½“éšç§ã€‚</p>
                    <div class="stat-item">k=2: æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰1ä¸ªç›¸ä¼¼èŠ‚ç‚¹</div>
                    <div class="stat-item">k=5: æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰4ä¸ªç›¸ä¼¼èŠ‚ç‚¹</div>
                    <div class="stat-item">kè¶Šå¤§ï¼Œéšç§ä¿æŠ¤è¶Šå¼ºï¼Œä½†å›¾ç»“æ„æ‰­æ›²è¶Šå¤§</div>
                </div>`;
            
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '<div class="step-item active">æŸ¥çœ‹k-åŒ¿ååŒ–åŸç†</div>';
        }
        
        function loadEdgePerturbation() {
            document.getElementById('top-title').textContent = 'è¾¹æ‰°åŠ¨é˜²å¾¡';
            document.getElementById('bottom-title').textContent = 'æ‰°åŠ¨ç­–ç•¥';
            
            document.getElementById('principle-content').innerHTML = `
                <div class="formula">
1. åˆ é™¤éƒ¨åˆ†è¾¹ï¼ˆä¿ç•™ç‡pï¼‰<br>
2. æ·»åŠ å™ªå£°è¾¹ï¼ˆå™ªå£°ç‡qï¼‰
                </div>
            `;
            
            renderTwoGraphs();
            document.getElementById('bottom-viz').innerHTML = 
                `<div class="stats-box">
                    <h4>è¾¹æ‰°åŠ¨ç­–ç•¥</h4>
                    <div class="stat-item">åˆ è¾¹: ç§»é™¤åŸå›¾ä¸­çš„éƒ¨åˆ†è¾¹</div>
                    <div class="stat-item">åŠ è¾¹: éšæœºæ·»åŠ ä¸å­˜åœ¨çš„è¾¹</div>
                    <div class="stat-item">ç›®æ ‡: ç ´åæ”»å‡»è€…çš„å›¾åŒ¹é…èƒ½åŠ›</div>
                    <div class="stat-item">æƒè¡¡: æ‰°åŠ¨è¶Šå¤§ï¼Œé˜²å¾¡è¶Šå¼ºï¼Œä½†å›¾æ•ˆç”¨ä¸‹é™</div>
                </div>`;
            
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '<div class="step-item active">æŸ¥çœ‹è¾¹æ‰°åŠ¨ç­–ç•¥</div>';
        }
        
        function renderDefenseChart(data) {
            const container = document.getElementById('top-viz');
            container.innerHTML = '<svg id="defense-svg"></svg>';
            const svg = d3.select('#defense-svg');
            const svgNode = svg.node();
            const width = svgNode.clientWidth || 500;
            const height = svgNode.clientHeight || 400;
            const margin = {top: 30, right: 30, bottom: 50, left: 60};
            
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data.results, d => d.epsilon)])
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([0, 1])
                .range([height - margin.bottom, margin.top]);
            
            const line = d3.line()
                .x(d => xScale(d.epsilon))
                .y(d => yScale(d.attack_accuracy));
            
            svg.append('path')
                .datum(data.results)
                .attr('class', 'chart-line')
                .attr('d', line)
                .attr('stroke', '#FF9800')
                .attr('stroke-width', 3);
            
            svg.selectAll('.chart-point')
                .data(data.results)
                .join('circle')
                .attr('class', 'chart-point')
                .attr('cx', d => xScale(d.epsilon))
                .attr('cy', d => yScale(d.attack_accuracy))
                .attr('r', 6)
                .attr('fill', '#FF9800')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 10);
                    showTooltip(event, `Îµ = ${d.epsilon.toFixed(1)}<br>å‡†ç¡®ç‡: ${(d.attack_accuracy * 100).toFixed(1)}%`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 6);
                    hideTooltip();
                });
            
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale));
            
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale).tickFormat(d => (d * 100).toFixed(0) + '%'));
            
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .attr('text-anchor', 'middle')
                .text('éšç§å‚æ•° Îµ (è¶Šå°è¶Šå®‰å…¨)')
                .attr('font-size', 13)
                .attr('font-weight', 'bold');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 15)
                .attr('text-anchor', 'middle')
                .text('æ”»å‡»å‡†ç¡®ç‡')
                .attr('font-size', 13)
                .attr('font-weight', 'bold');
            
            // æ·»åŠ å‚è€ƒçº¿
            svg.append('line')
                .attr('x1', margin.left)
                .attr('x2', width - margin.right)
                .attr('y1', yScale(0.5))
                .attr('y2', yScale(0.5))
                .attr('stroke', '#999')
                .attr('stroke-dasharray', '5,5')
                .attr('opacity', 0.5);
            
            svg.append('text')
                .attr('x', width - margin.right - 5)
                .attr('y', yScale(0.5) - 5)
                .attr('text-anchor', 'end')
                .text('50%åŸºå‡†çº¿')
                .attr('font-size', 10)
                .attr('fill', '#999');
        }
        
        function renderDefenseTable(data) {
            const container = document.getElementById('bottom-viz');
            let html = '<div class="stats-box"><h4>ä¸åŒÎµå€¼çš„é˜²å¾¡æ•ˆæœ</h4>';
            
            data.results.forEach((r, idx) => {
                const barWidth = r.attack_accuracy * 100;
                const color = r.attack_accuracy < 0.3 ? '#4CAF50' : r.attack_accuracy < 0.6 ? '#FF9800' : '#f44336';
                html += `<div class="stat-item" style="position: relative; padding-left: 10px;">
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${barWidth}%; 
                                background: ${color}; opacity: 0.2; border-radius: 4px; transition: all 0.3s;"></div>
                    <div style="position: relative; z-index: 1;">
                        <strong>Îµ = ${r.epsilon.toFixed(1)}</strong>: 
                        å‡†ç¡®ç‡ <span class="stat-value" style="color: ${color};">${(r.attack_accuracy*100).toFixed(1)}%</span>
                        ${r.attack_accuracy < 0.3 ? ' ğŸ›¡ï¸ å¼ºé˜²å¾¡' : r.attack_accuracy < 0.6 ? ' âš ï¸ ä¸­ç­‰é˜²å¾¡' : ' âš ï¸ å¼±é˜²å¾¡'}
                    </div>
                </div>`;
            });
            
            html += '<div class="stat-item" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px;">';
            html += '<small>ğŸ’¡ <strong>æç¤º:</strong> Îµè¶Šå°ï¼Œéšç§ä¿æŠ¤è¶Šå¼ºï¼Œä½†å›¾çš„æ•ˆç”¨å¯èƒ½ä¸‹é™</small>';
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        function loadDefenseSteps() {
            const stepList = document.getElementById('step-list');
            stepList.innerHTML = '<div class="step-item active">æŸ¥çœ‹å·®åˆ†éšç§é˜²å¾¡æ•ˆæœ</div>';
        }
        
        // ==================== é€šç”¨å‡½æ•° ====================
        
        function renderTwoGraphs() {
            const container = document.getElementById('top-viz');
            container.innerHTML = `
                <div class="graph-container">
                    <div class="graph-item">
                        <h4>åŸå§‹å›¾</h4>
                        <svg id="graph-orig-svg"></svg>
                    </div>
                    <div class="graph-item">
                        <h4>åŒ¿åå›¾</h4>
                        <svg id="graph-anon-svg"></svg>
                    </div>
                </div>
            `;
            
            renderSingleGraph(DATA.graph_orig, 'graph-orig-svg', '#2196F3');
            renderSingleGraph(DATA.graph_anon, 'graph-anon-svg', '#FF9800');
        }
        
        function renderSingleGraph(graphData, svgId, color) {
            const svg = d3.select('#' + svgId);
            svg.selectAll('*').remove(); // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            
            const svgNode = svg.node();
            const width = svgNode.clientWidth || 300;
            const height = svgNode.clientHeight || 300;
            
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.index).distance(40))
                .force('charge', d3.forceManyBody().strength(-100))
                .force('center', d3.forceCenter(width/2, height/2));
            
            const link = svg.append('g')
                .selectAll('line')
                .data(graphData.links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', 1.5);
            
            const node = svg.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', d => 4 + (d.degree || 0) * 0.3)
                .attr('fill', color)
                .on('mouseover', function(event, d) {
                    d3.select(this).classed('highlighted', true);
                    showTooltip(event, `èŠ‚ç‚¹ ${d.index}<br>åº¦: ${d.degree || 0}`);
                })
                .on('mouseout', function(event, d) {
                    if (!d3.select(this).classed('matched')) {
                        d3.select(this).classed('highlighted', false);
                    }
                    hideTooltip();
                });
            
            // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾
            const labels = svg.append('g')
                .selectAll('text')
                .data(graphData.nodes)
                .join('text')
                .attr('class', 'node-label')
                .attr('dy', '0.35em')
                .text(d => d.index);
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            setTimeout(() => simulation.stop(), 2000);
            
            // ä¿å­˜å›¾å…ƒç´ å¼•ç”¨
            if (svgId === 'graph-orig-svg') {
                origGraphSim = simulation;
                origGraphElements = {nodes: node, links: link, labels: labels};
            } else if (svgId === 'graph-anon-svg') {
                anonGraphSim = simulation;
                anonGraphElements = {nodes: node, links: link, labels: labels};
            }
            
            return {simulation, node, link, labels};
        }
        
        // æç¤ºæ¡†åŠŸèƒ½
        function showTooltip(event, html) {
            const tooltip = d3.select('body').selectAll('.tooltip').data([null]);
            const enter = tooltip.enter().append('div').attr('class', 'tooltip');
            const update = enter.merge(tooltip);
            
            update
                .html(html)
                .style('display', 'block')
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }
        
        function hideTooltip() {
            d3.select('.tooltip').style('display', 'none');
        }
        
        function selectStep(stepIdx) {
            currentStep = stepIdx;
            d3.selectAll('.step-item').classed('active', false);
            d3.selectAll('.step-item').filter((d, i) => i === stepIdx).classed('active', true);
        }
        
        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = d3.select('#play-btn');
            
            if (isPlaying) {
                btn.text('â¸ æš‚åœ');
                const totalSteps = d3.selectAll('.step-item').size();
                playInterval = setInterval(() => {
                    currentStep = (currentStep + 1) % totalSteps;
                    selectStep(currentStep);
                    
                    // è§¦å‘å½“å‰æ­¥éª¤çš„ç‚¹å‡»äº‹ä»¶ä»¥æ˜¾ç¤ºåŠ¨ç”»
                    const stepItems = document.querySelectorAll('.step-item');
                    if (stepItems[currentStep]) {
                        stepItems[currentStep].click();
                    }
                }, 2000); // æ¯2ç§’åˆ‡æ¢ä¸€æ­¥
            } else {
                btn.text('â–¶ï¸ æ’­æ”¾');
                clearInterval(playInterval);
            }
        }
        
        function resetDemo() {
            isPlaying = false;
            clearInterval(playInterval);
            d3.select('#play-btn').text('â–¶ï¸ æ’­æ”¾');
            currentStep = 0;
            selectStep(0);
        }
    </script>
</body>
</html>
