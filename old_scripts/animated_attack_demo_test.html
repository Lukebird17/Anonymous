<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åŒ¿ååŒ–æ”»å‡»åŠ¨ç”»æ¼”ç¤ºç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        :root {
            --color-blue: #2196F3;
            --color-orange: #FF9800;
            --color-green: #4CAF50;
            --color-red: #f44336;
            --color-gray: #9E9E9E;
            --color-attr-a: #e74c3c;
            --color-attr-b: #3498db;
            --color-attr-c: #2ecc71;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            overflow: hidden;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .viz-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .viz-card.main {
            flex: 2;
            min-height: 0;
        }
        
        .viz-card.info {
            flex: 1;
            min-height: 0;
        }
        
        .viz-card h2 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #f0f0f0;
        }
        
        .viz-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        
        .control-section {
            margin-bottom: 25px;
        }
        
        .control-section h3 {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .stage-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .stage-btn:hover {
            border-color: var(--color-blue);
            background: #e3f2fd;
        }
        
        .stage-btn.active {
            background: linear-gradient(135deg, var(--color-blue), #1976D2);
            color: white;
            border-color: var(--color-blue);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .method-grid {
            display: grid;
            gap: 10px;
        }
        
        .method-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 0.95em;
            text-align: left;
            transition: all 0.3s;
            position: relative;
        }
        
        .method-btn:hover {
            border-color: var(--color-blue);
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .method-btn.active {
            background: linear-gradient(135deg, var(--color-blue), #1976D2);
            color: white;
            border-color: var(--color-blue);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .method-btn .method-name {
            font-weight: 600;
            font-size: 1.05em;
        }
        
        .method-btn .method-desc {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .principle-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 1.7;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .principle-box .step {
            margin: 12px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .principle-box .step::before {
            content: "â–¶";
            position: absolute;
            left: 0;
            color: var(--color-orange);
            font-size: 0.8em;
        }
        
        .formula {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 4px solid var(--color-blue);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .ctrl-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .ctrl-btn.play {
            background: linear-gradient(135deg, var(--color-blue), #1976D2);
            color: white;
        }
        
        .ctrl-btn.play:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .ctrl-btn.pause {
            background: linear-gradient(135deg, var(--color-orange), #F57C00);
            color: white;
        }
        
        .ctrl-btn.reset {
            background: #e0e0e0;
        }
        
        .ctrl-btn.reset:hover {
            background: #bdbdbd;
        }
        
        /* å›¾å¯è§†åŒ–æ ·å¼ */
        .graph-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .graph-pane {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .graph-pane h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            margin: 0;
            font-size: 1em;
            text-align: center;
        }
        
        .graph-pane.original h3 {
            background: linear-gradient(135deg, var(--color-blue), #1976D2);
        }
        
        .graph-pane.anon h3 {
            background: linear-gradient(135deg, var(--color-gray), #757575);
        }
        
        .graph-svg {
            flex: 1;
            background: #fafafa;
        }
        
        svg {
            width: 100%;
            height: 100%;
        }
        
        /* èŠ‚ç‚¹æ ·å¼ */
        .node {
            stroke: white;
            stroke-width: 2.5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .node.unknown {
            fill: var(--color-gray) !important;
            opacity: 0.6;
        }
        
        .node.highlighted {
            stroke: var(--color-orange) !important;
            stroke-width: 5px !important;
            filter: drop-shadow(0 0 10px var(--color-orange)) !important;
        }
        
        .node.matched-success {
            stroke: var(--color-green) !important;
            stroke-width: 6px !important;
            filter: drop-shadow(0 0 8px var(--color-green)) !important;
        }
        
        .node.matched-fail {
            stroke: var(--color-red) !important;
            stroke-width: 6px !important;
            filter: drop-shadow(0 0 8px var(--color-red)) !important;
        }
        
        .node.attr-A { fill: var(--color-attr-a); }
        .node.attr-B { fill: var(--color-attr-b); }
        .node.attr-C { fill: var(--color-attr-c); }
        
        /* è¾¹æ ·å¼ */
        .link {
            stroke: #999;
            stroke-opacity: 0.3;
            stroke-width: 1px;
        }
        
        .link.highlighted {
            stroke: var(--color-orange) !important;
            stroke-width: 3px !important;
            stroke-opacity: 0.8 !important;
        }
        
        .link.walk-path {
            stroke: var(--color-blue) !important;
            stroke-width: 4px !important;
            stroke-opacity: 0.9 !important;
            animation: dash 2s linear infinite;
        }
        
        .link.removed {
            stroke: var(--color-red) !important;
            stroke-width: 2px !important;
            stroke-dasharray: 5,5;
            stroke-opacity: 0.7 !important;
        }
        
        .link.added {
            stroke: var(--color-green) !important;
            stroke-width: 2px !important;
            stroke-dasharray: 5,5;
            stroke-opacity: 0.7 !important;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
        
        /* åŒ¹é…è¿çº¿ */
        .match-line {
            stroke: var(--color-green);
            stroke-width: 3px;
            stroke-dasharray: 8,4;
            opacity: 0.8;
            animation: dash 1s linear infinite;
        }
        
        /* æ ‡ç­¾ */
        .node-label {
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            fill: #333;
            text-shadow: 0 0 3px white, 0 0 3px white;
        }
        
        /* æç¤ºæ¡† */
        .tooltip {
            position: absolute;
            padding: 12px 15px;
            background: rgba(0,0,0,0.9);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            max-width: 300px;
        }
        
        /* åŠ¨ç”»çŠ¶æ€æ˜¾ç¤º */
        .animation-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 100;
        }
        
        /* å›¾ä¾‹ */
        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.85em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* ä¿¡æ¯é¢æ¿æ ·å¼ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .info-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--color-blue);
            margin-bottom: 5px;
        }
        
        .info-label {
            font-size: 0.9em;
            color: #666;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ å›¾åŒ¿ååŒ–æ”»å‡»åŠ¨ç”»æ¼”ç¤ºç³»ç»Ÿ</h1>
            <p style="color: #666; margin-top: 5px;">
                çœŸå®ç®—æ³•åŸç† Â· åŠ¨ç”»æ¼”ç¤º Â· äº¤äº’æ¢ç´¢
            </p>
        </header>
        
        <div class="main-content">
            <!-- å·¦ä¾§å¯è§†åŒ–åŒºåŸŸ -->
            <div class="left-panel">
                <!-- ä¸»å›¾å¯è§†åŒ– -->
                <div class="viz-card main">
                    <h2 id="viz-title">å›¾ç½‘ç»œå¯è§†åŒ–</h2>
                    <div class="viz-content">
                        <div class="graph-container">
                            <div class="graph-pane original">
                                <h3>ğŸ”µ åŸå§‹å›¾ (Original Graph)</h3>
                                <div class="graph-svg">
                                    <svg id="graph-orig"></svg>
                                </div>
                            </div>
                            <div class="graph-pane anon">
                                <h3>â“ åŒ¿åå›¾ (Anonymized Graph)</h3>
                                <div class="graph-svg">
                                    <svg id="graph-anon"></svg>
                                    <div class="legend" id="legend-anon"></div>
                                </div>
                            </div>
                        </div>
                        <div class="animation-status" id="anim-status" style="display: none;">
                            å‡†å¤‡ä¸­...
                        </div>
                    </div>
                </div>
                
                <!-- è¯¦ç»†ä¿¡æ¯ -->
                <div class="viz-card info">
                    <h2>ğŸ“Š å®æ—¶ç»Ÿè®¡</h2>
                    <div class="viz-content">
                        <div class="info-grid" id="info-display">
                            <div class="info-item">
                                <div class="info-value">50</div>
                                <div class="info-label">èŠ‚ç‚¹æ•°</div>
                            </div>
                            <div class="info-item">
                                <div class="info-value">0</div>
                                <div class="info-label">å½“å‰æ­¥éª¤</div>
                            </div>
                            <div class="info-item">
                                <div class="info-value">0</div>
                                <div class="info-label">å·²åŒ¹é…</div>
                            </div>
                            <div class="info-item">
                                <div class="info-value">0%</div>
                                <div class="info-label">å‡†ç¡®ç‡</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- é˜¶æ®µé€‰æ‹© -->
                <div class="control-section">
                    <h3>ğŸ“š æ”»å‡»é˜¶æ®µ</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                        <button class="stage-btn active" data-stage="1">é˜¶æ®µä¸€</button>
                        <button class="stage-btn" data-stage="2">é˜¶æ®µäºŒ</button>
                        <button class="stage-btn" data-stage="3">é˜¶æ®µä¸‰</button>
                    </div>
                </div>
                
                <!-- æ–¹æ³•é€‰æ‹© -->
                <div class="control-section">
                    <h3 id="stage-title">ğŸ¯ é˜¶æ®µä¸€ï¼šèº«ä»½å»åŒ¿ååŒ–</h3>
                    <div class="method-grid" id="method-selector">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- åŸç†è¯´æ˜ -->
                <div class="control-section">
                    <h3>ğŸ“– æ–¹æ³•åŸç†</h3>
                    <div class="principle-box" id="principle-display">
                        <p style="text-align: center; color: #999;">
                            è¯·é€‰æ‹©ä¸€ä¸ªæ–¹æ³•æŸ¥çœ‹è¯¦ç»†åŸç†
                        </p>
                    </div>
                </div>
                
                <!-- æ’­æ”¾æ§åˆ¶ -->
                <div class="control-section">
                    <h3>âš™ï¸ åŠ¨ç”»æ§åˆ¶</h3>
                    <div class="controls">
                        <button class="ctrl-btn play" id="play-btn">â–¶ï¸ å¼€å§‹æ¼”ç¤º</button>
                        <button class="ctrl-btn reset" id="reset-btn">ğŸ”„ é‡ç½®</button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 0.85em;">
                        <strong>ğŸ’¡ æç¤º:</strong> ç‚¹å‡»"å¼€å§‹æ¼”ç¤º"è§‚çœ‹åŠ¨ç”»ï¼Œæ‚¬åœèŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let DATA = null;
        let currentStage = 1;
        let currentMethod = null;
        let isPlaying = false;
        let currentStep = 0;
        let animationInterval = null;
        
        // å›¾å¯è§†åŒ–å¯¹è±¡
        let origSim = null;
        let anonSim = null;
        let origElements = {nodes: null, links: null, labels: null};
        let anonElements = {nodes: null, links: null, labels: null};
        
        // åŠ è½½æ•°æ®
        d3.json('real_data_demo.json?v=1767359096').then(data => {
            DATA = data;
            console.log('âœ… æ•°æ®åŠ è½½æˆåŠŸ', data);
            initializeUI();
        }).catch(err => {
            console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', err);
            alert('æ— æ³•åŠ è½½ real_data_demo.jsonï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼\né”™è¯¯è¯¦æƒ…: ' + err.message);
        });
        
        function initializeUI() {
            // æ¸²æŸ“åˆå§‹å›¾
            renderGraphs();
            
            // ç»‘å®šé˜¶æ®µé€‰æ‹©æŒ‰é’®
            d3.selectAll('.stage-btn').on('click', function() {
                const stage = parseInt(this.dataset.stage);
                selectStage(stage);
            });
            
            // ç»‘å®šæ§åˆ¶æŒ‰é’®
            d3.select('#play-btn').on('click', toggleAnimation);
            d3.select('#reset-btn').on('click', resetAnimation);
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé˜¶æ®µ
            selectStage(1);
        }
        
        function selectStage(stage) {
            currentStage = stage;
            currentMethod = null;
            resetAnimation();
            
            // æ›´æ–°é˜¶æ®µæŒ‰é’®
            d3.selectAll('.stage-btn').classed('active', false);
            d3.select(`.stage-btn[data-stage="${stage}"]`).classed('active', true);
            
            // æ›´æ–°æ ‡é¢˜å’Œæ–¹æ³•åˆ—è¡¨
            const titles = {
                1: 'ğŸ¯ é˜¶æ®µä¸€ï¼šèº«ä»½å»åŒ¿ååŒ–',
                2: 'ğŸ¯ é˜¶æ®µäºŒï¼šå±æ€§æ¨æ–­æ”»å‡»',
                3: 'ğŸ¯ é˜¶æ®µä¸‰ï¼šå·®åˆ†éšç§é˜²å¾¡'
            };
            document.getElementById('stage-title').textContent = titles[stage];
            
            // æ¸²æŸ“æ–¹æ³•æŒ‰é’®
            renderMethodButtons();
        }
        
        function renderMethodButtons() {
            const methodSelector = document.getElementById('method-selector');
            methodSelector.innerHTML = '';
            
            const methods = {
                1: [
                    {id: 'greedy', name: 'è´ªå¿ƒç‰¹å¾åŒ¹é…', desc: 'é€æ­¥åŒ¹é…æœ€ç›¸ä¼¼èŠ‚ç‚¹å¯¹'},
                    {id: 'hungarian', name: 'åŒˆç‰™åˆ©ç®—æ³•', desc: 'å…¨å±€æœ€ä¼˜äºŒåˆ†åŒ¹é…'},
                    {id: 'graph_kernel', name: 'å›¾æ ¸æ–¹æ³•', desc: 'åŸºäºå­å›¾ç»“æ„æ¯”è¾ƒ'},
                    {id: 'deepwalk', name: 'DeepWalkåµŒå…¥', desc: 'éšæœºæ¸¸èµ° + å›¾åµŒå…¥'}
                ],
                2: [
                    {id: 'attribute', name: 'é‚»å±…æŠ•ç¥¨æ¨æ–­', desc: 'åŸºäºé‚»å±…å±æ€§æŠ•ç¥¨'},
                    {id: 'label_propagation', name: 'æ ‡ç­¾ä¼ æ’­', desc: 'è¿­ä»£æ‰©æ•£æ ‡ç­¾ä¿¡æ¯'},
                    {id: 'graphsage', name: 'GraphSAGE', desc: 'å›¾ç¥ç»ç½‘ç»œèšåˆ'}
                ],
                3: [
                    {id: 'defense', name: 'å·®åˆ†éšç§é˜²å¾¡', desc: 'è¾¹æ‰°åŠ¨æœºåˆ¶'},
                    {id: 'k_anonymity', name: 'k-åŒ¿ååŒ–', desc: 'èŠ‚ç‚¹åº¦æ•°åŒ¿ååŒ–'},
                    {id: 'noise_injection', name: 'å™ªå£°æ³¨å…¥', desc: 'æ·»åŠ è™šå‡èŠ‚ç‚¹å’Œè¾¹'}
                ]
            };
            
            const stageMethods = methods[currentStage] || [];
            
            stageMethods.forEach(m => {
                const btn = document.createElement('button');
                btn.className = 'method-btn';
                btn.dataset.method = m.id;
                btn.innerHTML = `
                    <div class="method-name">${m.name}</div>
                    <div class="method-desc">${m.desc}</div>
                `;
                btn.onclick = () => selectMethod(m.id);
                methodSelector.appendChild(btn);
            });
        }
        
        function selectMethod(method) {
            currentMethod = method;
            currentStep = 0;
            isPlaying = false;
            clearInterval(animationInterval);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            d3.selectAll('.method-btn').classed('active', false);
            d3.select(`.method-btn[data-method="${method}"]`).classed('active', true);
            d3.select('#play-btn').text('â–¶ï¸ å¼€å§‹æ¼”ç¤º').classed('pause', false);
            
            // æ˜¾ç¤ºåŸç†
            showPrinciple(method);
            
            // é‡ç½®å›¾
            resetGraphVisualization();
            
            // æ›´æ–°å›¾ä¾‹
            updateLegend(method);
            
            // æ›´æ–°æ ‡é¢˜
            updateTitle(method);
        }
        
        function showPrinciple(method) {
            const principles = {
                greedy: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">è´ªå¿ƒç‰¹å¾åŒ¹é…åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1:</strong> è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»“æ„ç‰¹å¾ï¼ˆåº¦æ•°ã€èšç±»ç³»æ•°ã€ä¸‰è§’å½¢æ•°ç­‰ï¼‰
                    </div>
                    <div class="formula">f(v) = [degree, clustering, triangles, ...]</div>
                    <div class="step">
                        <strong>æ­¥éª¤2:</strong> è®¡ç®—åŸå§‹å›¾å’ŒåŒ¿åå›¾èŠ‚ç‚¹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦
                    </div>
                    <div class="formula">S[i,j] = cos(f(vi), f(vj'))</div>
                    <div class="step">
                        <strong>æ­¥éª¤3:</strong> è´ªå¿ƒé€‰æ‹©ï¼šæ¯æ¬¡é€‰æ‹©ç›¸ä¼¼åº¦æœ€å¤§çš„èŠ‚ç‚¹å¯¹è¿›è¡ŒåŒ¹é…
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯ŸèŠ‚ç‚¹å¦‚ä½•é€å¯¹åŒ¹é…ï¼Œç»¿è‰²è¿çº¿è¡¨ç¤ºå·²åŒ¹é…
                    </div>
                `,
                hungarian: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">åŒˆç‰™åˆ©ç®—æ³•åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1-2:</strong> ä¸è´ªå¿ƒç›¸åŒï¼Œè®¡ç®—ç‰¹å¾å’Œç›¸ä¼¼åº¦çŸ©é˜µ
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤3:</strong> è½¬æ¢ä¸ºæˆæœ¬çŸ©é˜µ C = -S
                    </div>
                    <div class="formula">min Î£ C[i, Ï€(i)]</div>
                    <div class="step">
                        <strong>æ­¥éª¤4:</strong> ä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•æ±‚è§£æœ€å°æˆæœ¬åŒ¹é…
                    </div>
                    <div class="step">
                        <strong>ä¼˜åŠ¿:</strong> ä¿è¯å…¨å±€æœ€ä¼˜ï¼ˆvs è´ªå¿ƒçš„å±€éƒ¨æœ€ä¼˜ï¼‰
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> ä¸€æ¬¡æ€§æ˜¾ç¤ºæ‰€æœ‰æœ€ä¼˜åŒ¹é…
                    </div>
                `,
                graph_kernel: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">å›¾æ ¸æ–¹æ³•åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1:</strong> æå–æ¯ä¸ªèŠ‚ç‚¹çš„å±€éƒ¨å­å›¾ï¼ˆ1-hop, 2-hopé‚»å±…ï¼‰
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤2:</strong> ä½¿ç”¨ Weisfeiler-Lehman æ ¸è®¡ç®—å­å›¾ç›¸ä¼¼åº¦
                    </div>
                    <div class="formula">label'(v) = hash(label(v) + sort([label(u) for uâˆˆN(v)]))</div>
                    <div class="step">
                        <strong>æ­¥éª¤3:</strong> åŸºäºæ ¸çŸ©é˜µè¿›è¡ŒèŠ‚ç‚¹åŒ¹é…
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿå­å›¾å¦‚ä½•ä»ä¸­å¿ƒèŠ‚ç‚¹æ‰©å±•
                    </div>
                `,
                deepwalk: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">DeepWalkå›¾åµŒå…¥åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1:</strong> ä»æ¯ä¸ªèŠ‚ç‚¹å¼€å§‹è¿›è¡Œå¤šæ¡éšæœºæ¸¸èµ°
                    </div>
                    <div class="formula">è·¯å¾„: [v, u1, u2, ..., ut]</div>
                    <div class="step">
                        <strong>æ­¥éª¤2:</strong> ä½¿ç”¨ Skip-gram æ¨¡å‹è®­ç»ƒèŠ‚ç‚¹åµŒå…¥
                    </div>
                    <div class="formula">max Î£ log P(neighbors(v) | v)</div>
                    <div class="step">
                        <strong>æ­¥éª¤3:</strong> åœ¨åµŒå…¥ç©ºé—´ä¸­åŒ¹é…ç›¸ä¼¼èŠ‚ç‚¹
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿéšæœºæ¸¸èµ°è·¯å¾„å¦‚ä½•éå†å›¾
                    </div>
                `,
                attribute: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">å±æ€§æ¨æ–­åŸç†</h4>
                    <div class="step">
                        <strong>é—®é¢˜:</strong> å·²çŸ¥éƒ¨åˆ†èŠ‚ç‚¹çš„å±æ€§ï¼ˆé¢œè‰²ï¼‰ï¼Œæ¨æ–­æœªçŸ¥èŠ‚ç‚¹ï¼ˆç°è‰²ï¼‰çš„å±æ€§
                    </div>
                    <div class="step">
                        <strong>æ–¹æ³•:</strong> é‚»å±…æŠ•ç¥¨ - ç»Ÿè®¡é‚»å±…çš„å±æ€§æ ‡ç­¾
                    </div>
                    <div class="formula">predicted_attr(v) = argmax(Counter([attr(u) for uâˆˆN(v)]))</div>
                    <div class="step">
                        <strong>å±æ€§é¢œè‰²:</strong><br>
                        ğŸ”´ å±æ€§Aï¼ˆçº¢è‰²å¡«å……ï¼‰<br>
                        ğŸ”µ å±æ€§Bï¼ˆè“è‰²å¡«å……ï¼‰<br>
                        ğŸŸ¢ å±æ€§Cï¼ˆç»¿è‰²å¡«å……ï¼‰<br>
                        âš« æœªçŸ¥å±æ€§ï¼ˆç°è‰²å¡«å……ï¼‰
                    </div>
                    <div class="step">
                        <strong>æ¨æ–­æˆåŠŸæ ‡è®°:</strong><br>
                        ğŸ’™ è“è‰²è¾¹æ¡† = å·²æˆåŠŸæ¨æ–­ï¼ˆé¿å…ä¸å±æ€§é¢œè‰²å†²çªï¼‰
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿç°è‰²èŠ‚ç‚¹å¦‚ä½•é€šè¿‡é‚»å±…æŠ•ç¥¨å˜æˆå¯¹åº”å±æ€§çš„é¢œè‰²ï¼Œå¹¶åŠ ä¸Šè“è‰²è¾¹æ¡†
                    </div>
                `,
                attribute: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">å±æ€§æ¨æ–­åŸç†</h4>
                    <div class="step">
                        <strong>é—®é¢˜:</strong> å·²çŸ¥éƒ¨åˆ†èŠ‚ç‚¹çš„å±æ€§ï¼ˆé¢œè‰²ï¼‰ï¼Œæ¨æ–­æœªçŸ¥èŠ‚ç‚¹ï¼ˆç°è‰²ï¼‰çš„å±æ€§
                    </div>
                    <div class="step">
                        <strong>æ–¹æ³•:</strong> é‚»å±…æŠ•ç¥¨ - ç»Ÿè®¡é‚»å±…çš„å±æ€§æ ‡ç­¾
                    </div>
                    <div class="formula">predicted_attr(v) = argmax(Counter([attr(u) for uâˆˆN(v)]))</div>
                    <div class="step">
                        <strong>å±æ€§é¢œè‰²:</strong><br>
                        ğŸ”´ å±æ€§Aï¼ˆçº¢è‰²å¡«å……ï¼‰<br>
                        ğŸ”µ å±æ€§Bï¼ˆè“è‰²å¡«å……ï¼‰<br>
                        ğŸŸ¢ å±æ€§Cï¼ˆç»¿è‰²å¡«å……ï¼‰<br>
                        âš« æœªçŸ¥å±æ€§ï¼ˆç°è‰²å¡«å……ï¼‰
                    </div>
                    <div class="step">
                        <strong>æ¨æ–­æˆåŠŸæ ‡è®°:</strong><br>
                        ğŸ’™ è“è‰²è¾¹æ¡† = å·²æˆåŠŸæ¨æ–­ï¼ˆé¿å…ä¸å±æ€§é¢œè‰²å†²çªï¼‰
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿç°è‰²èŠ‚ç‚¹å¦‚ä½•é€šè¿‡é‚»å±…æŠ•ç¥¨å˜æˆå¯¹åº”å±æ€§çš„é¢œè‰²ï¼Œå¹¶åŠ ä¸Šè“è‰²è¾¹æ¡†
                    </div>
                `,
                label_propagation: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">æ ‡ç­¾ä¼ æ’­åŸç†</h4>
                    <div class="step">
                        <strong>é—®é¢˜:</strong> è¿­ä»£æ–¹å¼ä¼ æ’­å·²çŸ¥èŠ‚ç‚¹çš„å±æ€§æ ‡ç­¾
                    </div>
                    <div class="step">
                        <strong>ç®—æ³•æµç¨‹:</strong><br>
                        1. åˆå§‹åŒ–ï¼šå·²çŸ¥èŠ‚ç‚¹å›ºå®šæ ‡ç­¾ï¼ŒæœªçŸ¥èŠ‚ç‚¹æ ‡ç­¾ä¸ºç©º<br>
                        2. è¿­ä»£ï¼šæ¯ä¸ªæœªçŸ¥èŠ‚ç‚¹é‡‡ç”¨é‚»å±…ä¸­æœ€é¢‘ç¹çš„æ ‡ç­¾<br>
                        3. é‡å¤ç›´åˆ°æ”¶æ•›æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
                    </div>
                    <div class="formula">Y(t+1) = D^(-1/2) A D^(-1/2) Y(t)</div>
                    <div class="step">
                        <strong>ä¼˜åŠ¿:</strong> è€ƒè™‘äº†å¤šè·³é‚»å±…ä¿¡æ¯ï¼Œä¼ æ’­èŒƒå›´æ›´å¹¿
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿæ ‡ç­¾å¦‚ä½•åƒæ³¢çº¹ä¸€æ ·ä»å·²çŸ¥èŠ‚ç‚¹æ‰©æ•£åˆ°æœªçŸ¥èŠ‚ç‚¹
                    </div>
                `,
                graphsage: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">GraphSAGEåŸç†</h4>
                    <div class="step">
                        <strong>æ ¸å¿ƒæ€æƒ³:</strong> é€šè¿‡é‡‡æ ·å’Œèšåˆé‚»å±…ç‰¹å¾æ¥å­¦ä¹ èŠ‚ç‚¹è¡¨ç¤º
                    </div>
                    <div class="step">
                        <strong>ç®—æ³•æµç¨‹:</strong><br>
                        1. é‡‡æ ·ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹é‡‡æ ·å›ºå®šæ•°é‡çš„é‚»å±…<br>
                        2. èšåˆï¼šä½¿ç”¨èšåˆå‡½æ•°ï¼ˆMean/LSTM/Poolï¼‰æ±‡æ€»é‚»å±…ç‰¹å¾<br>
                        3. æ›´æ–°ï¼šæ‹¼æ¥è‡ªèº«å’Œé‚»å±…ç‰¹å¾ï¼Œé€šè¿‡ç¥ç»ç½‘ç»œæ›´æ–°
                    </div>
                    <div class="formula">h_v^(k) = Ïƒ(W Â· CONCAT(h_v^(k-1), AGG({h_u^(k-1), uâˆˆN(v)})))</div>
                    <div class="step">
                        <strong>ä¼˜åŠ¿:</strong> å¯å¤„ç†å¤§è§„æ¨¡å›¾ï¼Œæ”¯æŒå½’çº³å­¦ä¹ 
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯ŸèŠ‚ç‚¹å¦‚ä½•é€šè¿‡å¤šå±‚èšåˆè·å–k-hopé‚»åŸŸä¿¡æ¯
                    </div>
                `,
                defense: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">å·®åˆ†éšç§é˜²å¾¡åŸç†</h4>
                    <div class="step">
                        <strong>Îµ-å·®åˆ†éšç§:</strong> ä¿æŠ¤å›¾ç»“æ„éšç§
                    </div>
                    <div class="formula">P(M(G) âˆˆ S) / P(M(G') âˆˆ S) â‰¤ e^Îµ</div>
                    <div class="step">
                        <strong>è¾¹æ‰°åŠ¨æœºåˆ¶:</strong><br>
                        â€¢ ä»¥æ¦‚ç‡ p = 1/(1+e^Îµ) åˆ é™¤ç°æœ‰è¾¹<br>
                        â€¢ ä»¥æ¦‚ç‡ p = 1/(1+e^Îµ) æ·»åŠ å™ªå£°è¾¹
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong><br>
                        ğŸ”´ çº¢è‰²è™šçº¿ = åˆ é™¤çš„è¾¹<br>
                        ğŸŸ¢ ç»¿è‰²è™šçº¿ = æ·»åŠ çš„è¾¹
                    </div>
                    <div class="step">
                        <strong>æƒè¡¡:</strong> Îµâ†“ éšç§â†‘ æ•ˆç”¨â†“
                    </div>
                `,
                k_anonymity: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">k-åŒ¿ååŒ–åŸç†</h4>
                    <div class="step">
                        <strong>ç›®æ ‡:</strong> ä½¿æ¯ä¸ªèŠ‚ç‚¹è‡³å°‘ä¸k-1ä¸ªå…¶ä»–èŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„ç»“æ„ç‰¹å¾
                    </div>
                    <div class="step">
                        <strong>æ–¹æ³•:</strong> åº¦æ•°åºåˆ—k-åŒ¿ååŒ–<br>
                        â€¢ è¯†åˆ«åº¦æ•°ç‹¬ç‰¹çš„èŠ‚ç‚¹<br>
                        â€¢ é€šè¿‡æ·»åŠ /åˆ é™¤è¾¹ä½¿åº¦æ•°ç›¸åŒ<br>
                        â€¢ ç¡®ä¿æ¯ä¸ªåº¦æ•°è‡³å°‘æœ‰kä¸ªèŠ‚ç‚¹
                    </div>
                    <div class="formula">âˆ€v, |{u : degree(u) = degree(v)}| â‰¥ k</div>
                    <div class="step">
                        <strong>å‚æ•°k:</strong><br>
                        â€¢ k=2: æœ€å°åŒ¿ååŒ–<br>
                        â€¢ k=5: ä¸­ç­‰ä¿æŠ¤<br>
                        â€¢ k=10: å¼ºä¿æŠ¤ä½†å›¾æ‰­æ›²å¤§
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong> è§‚å¯Ÿå¦‚ä½•ä¿®æ”¹å›¾ä½¿èŠ‚ç‚¹åº¦æ•°åˆ†ç»„ï¼Œæ¯ç»„è‡³å°‘kä¸ª
                    </div>
                `,
                noise_injection: `
                    <h4 style="color: var(--color-blue); margin-bottom: 10px;">å™ªå£°æ³¨å…¥é˜²å¾¡åŸç†</h4>
                    <div class="step">
                        <strong>ç­–ç•¥:</strong> å‘å›¾ä¸­æ³¨å…¥è™šå‡èŠ‚ç‚¹å’Œè¾¹æ¥æ··æ·†æ”»å‡»è€…
                    </div>
                    <div class="step">
                        <strong>æ–¹æ³•:</strong><br>
                        1. <strong>è™šå‡èŠ‚ç‚¹æ³¨å…¥:</strong> æ·»åŠ ä¸å­˜åœ¨çš„èŠ‚ç‚¹<br>
                        2. <strong>è™šå‡è¾¹æ³¨å…¥:</strong> åœ¨çœŸå®èŠ‚ç‚¹é—´æ·»åŠ å‡è¾¹<br>
                        3. <strong>åº¦æ•°æ‰°åŠ¨:</strong> ä½¿æ”»å‡»è€…æ— æ³•å‡†ç¡®è®¡ç®—èŠ‚ç‚¹åº¦æ•°
                    </div>
                    <div class="step">
                        <strong>æ•ˆæœ:</strong><br>
                        â€¢ æ··æ·†èŠ‚ç‚¹ç‰¹å¾ï¼ˆåº¦æ•°ã€èšç±»ç³»æ•°ç­‰ï¼‰<br>
                        â€¢ é™ä½ç»“æ„ç›¸ä¼¼åº¦åŒ¹é…å‡†ç¡®ç‡<br>
                        â€¢ å¢åŠ æ”»å‡»è€…çš„ä¸ç¡®å®šæ€§
                    </div>
                    <div class="step">
                        <strong>æ¼”ç¤ºå†…å®¹:</strong><br>
                        ğŸŸ£ ç´«è‰²èŠ‚ç‚¹ = è™šå‡èŠ‚ç‚¹<br>
                        ğŸŸ¡ é»„è‰²è¾¹ = è™šå‡è¾¹
                    </div>
                `
            };
            
            document.getElementById('principle-display').innerHTML = 
                principles[method] || '<p style="color: #999;">æš‚æ— åŸç†è¯´æ˜</p>';
        }
        
        function updateLegend(method) {
            const legendDiv = document.getElementById('legend-anon');
            let html = '';
            
            if (method === 'attribute' || method === 'label_propagation' || method === 'graphsage') {
                html = `
                    <strong>å±æ€§å›¾ä¾‹:</strong>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-attr-a);"></div>
                        å±æ€§ A
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-attr-b);"></div>
                        å±æ€§ B
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-attr-c);"></div>
                        å±æ€§ C
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-gray);"></div>
                        æœªçŸ¥å±æ€§
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: white; border: 4px solid var(--color-blue);"></div>
                        å·²æ¨æ–­
                    </div>
                `;
            } else if (method === 'defense' || method === 'k_anonymity') {
                html = `
                    <strong>è¾¹çŠ¶æ€:</strong>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #999; margin-right: 8px;"></div>
                        åŸå§‹è¾¹
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: var(--color-red); border-top: 2px dashed var(--color-red); margin-right: 8px;"></div>
                        åˆ é™¤çš„è¾¹
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: var(--color-green); border-top: 2px dashed var(--color-green); margin-right: 8px;"></div>
                        æ·»åŠ çš„è¾¹
                    </div>
                `;
            } else if (method === 'noise_injection') {
                html = `
                    <strong>å™ªå£°æ³¨å…¥:</strong>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-blue);"></div>
                        çœŸå®èŠ‚ç‚¹
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9C27B0;"></div>
                        è™šå‡èŠ‚ç‚¹
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #999; margin-right: 8px;"></div>
                        çœŸå®è¾¹
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #FFC107; border-top: 2px dashed #FFC107; margin-right: 8px;"></div>
                        è™šå‡è¾¹
                    </div>
                `;
            } else {
                html = `
                    <strong>èŠ‚ç‚¹çŠ¶æ€:</strong>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-blue);"></div>
                        å·²çŸ¥èº«ä»½
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--color-gray);"></div>
                        æœªçŸ¥èº«ä»½
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: white; border: 4px solid var(--color-green);"></div>
                        åŒ¹é…æˆåŠŸ
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: white; border: 4px solid var(--color-red);"></div>
                        åŒ¹é…å¤±è´¥
                    </div>
                `;
            }
            
            legendDiv.innerHTML = html;
        }
        
        function updateTitle(method) {
            const titles = {
                greedy: 'è´ªå¿ƒç‰¹å¾åŒ¹é… - é€æ­¥åŒ¹é…æ¼”ç¤ºï¼ˆç»¿æ¡†=æˆåŠŸï¼Œçº¢æ¡†=å¤±è´¥ï¼‰',
                hungarian: 'åŒˆç‰™åˆ©ç®—æ³• - å…¨å±€æœ€ä¼˜åŒ¹é…',
                graph_kernel: 'å›¾æ ¸æ–¹æ³• - å­å›¾ç»“æ„æ¯”è¾ƒ',
                deepwalk: 'DeepWalk - åŸå›¾ä¸Šçš„éšæœºæ¸¸èµ°æ¼”ç¤º',
                attribute: 'é‚»å±…æŠ•ç¥¨ - å±æ€§æ¨æ–­æ¼”ç¤ºï¼ˆè“æ¡†=å·²æ¨æ–­ï¼‰',
                label_propagation: 'æ ‡ç­¾ä¼ æ’­ - è¿­ä»£æ‰©æ•£æ¼”ç¤º',
                graphsage: 'GraphSAGE - å¤šå±‚é‚»å±…èšåˆæ¼”ç¤º',
                defense: 'å·®åˆ†éšç§é˜²å¾¡ - è¾¹æ‰°åŠ¨æ¼”ç¤º',
                k_anonymity: 'k-åŒ¿ååŒ– - åº¦æ•°åˆ†ç»„æ¼”ç¤º',
                noise_injection: 'å™ªå£°æ³¨å…¥ - è™šå‡èŠ‚ç‚¹å’Œè¾¹æ³¨å…¥ï¼ˆç´«è‰²=è™šå‡èŠ‚ç‚¹ï¼Œé»„è‰²=è™šå‡è¾¹ï¼‰'
            };
            
            document.getElementById('viz-title').textContent = titles[method] || 'å›¾ç½‘ç»œå¯è§†åŒ–';
        }
        
        function renderGraphs() {
            if (!DATA) return;
            
            renderSingleGraph('orig', DATA.graph, 'graph-orig');
            renderSingleGraph('anon', DATA.graph, 'graph-anon');
        }
        
        function renderSingleGraph(type, graphData, svgId) {
            const svg = d3.select('#' + svgId);
            svg.selectAll('*').remove();
            
            const container = svg.node().parentNode;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // åˆ›å»ºç¼©æ”¾
            const zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', (event) => g.attr('transform', event.transform));
            
            svg.call(zoom);
            const g = svg.append('g');
            
            // åŠ›å¯¼å‘å¸ƒå±€ï¼ˆè°ƒæ•´å‚æ•°è®©èŠ‚ç‚¹æ›´åˆ†æ•£ï¼‰
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links)
                    .id(d => d.id)  // ä½¿ç”¨idè€Œä¸æ˜¯index
                    .distance(150))  // å¢åŠ è¾¹çš„é•¿åº¦ï¼š40 -> 150
                .force('charge', d3.forceManyBody().strength(-800))  // å¢åŠ æ’æ–¥åŠ›ï¼š-150 -> -800
                .force('center', d3.forceCenter(width/2, height/2))
                .force('collision', d3.forceCollide().radius(30));  // å¢åŠ ç¢°æ’åŠå¾„ï¼š15 -> 30
            
            // ç»˜åˆ¶è¾¹
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .join('line')
                .attr('class', 'link');
            
            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .join('circle')
                .attr('class', d => {
                    let classes = 'node';
                    if (type === 'anon' && !d.known) classes += ' unknown';
                    if (d.attribute) classes += ' attr-' + d.attribute;
                    return classes;
                })
                .attr('r', d => Math.max(8, Math.sqrt(d.degree) * 2.5))
                .attr('fill', d => {
                    if (type === 'anon' && !d.known) return 'var(--color-gray)';
                    return 'var(--color-blue)';
                })
                .attr('stroke', '#fff')  // æ·»åŠ é»˜è®¤ç™½è‰²è¾¹æ¡†
                .attr('stroke-width', 2)  // é»˜è®¤è¾¹æ¡†å®½åº¦
                .on('mouseover', function(event, d) {
                    showTooltip(event, d, type);
                })
                .on('mouseout', hideTooltip)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // æ·»åŠ æ ‡ç­¾
            const labels = g.append('g')
                .selectAll('text')
                .data(graphData.nodes.filter(d => d.degree > 5))
                .join('text')
                .attr('class', 'node-label')
                .text(d => d.id);
            
            // æ›´æ–°ä½ç½®
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // 3ç§’ååœæ­¢
            setTimeout(() => simulation.stop(), 3000);
            
            // æ‹–æ‹½å‡½æ•°
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // ä¿å­˜å¼•ç”¨
            if (type === 'orig') {
                origSim = simulation;
                origElements = {nodes: node, links: link, labels: labels, g: g, svg: svg};
            } else {
                anonSim = simulation;
                anonElements = {nodes: node, links: link, labels: labels, g: g, svg: svg};
            }
        }
        
        function showTooltip(event, d, type) {
            let html = `<strong>èŠ‚ç‚¹ ${d.id}</strong><br>`;
            html += `åº¦æ•°: ${d.degree}<br>`;
            if (type === 'anon') {
                html += d.known ? 'çŠ¶æ€: å·²çŸ¥èº«ä»½' : 'çŠ¶æ€: æœªçŸ¥èº«ä»½';
            }
            if (d.attribute) {
                html += `<br>å±æ€§: ${d.attribute}`;
            }
            
            let tooltip = d3.select('.tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div').attr('class', 'tooltip');
            }
            
            tooltip
                .html(html)
                .style('display', 'block')
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }
        
        function hideTooltip() {
            d3.select('.tooltip').style('display', 'none');
        }
        
        function resetGraphVisualization() {
            if (!origElements.nodes || !anonElements.nodes) return;
            
            // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹çš„æ ·å¼
            origElements.nodes.classed('highlighted matched-success matched-fail', false);
            anonElements.nodes.classed('highlighted matched-success matched-fail', false);
            origElements.links.classed('highlighted walk-path removed added', false);
            anonElements.links.classed('highlighted walk-path removed added', false);
            
            // ç§»é™¤åŒ¹é…çº¿
            d3.selectAll('.match-line').remove();
            
            // é‡ç½®åŒ¿åå›¾èŠ‚ç‚¹é¢œè‰²
            if (currentMethod === 'attribute') {
                anonElements.nodes.attr('fill', d => {
                    if (d.known) {
                        if (d.attribute === 'A') return 'var(--color-attr-a)';
                        if (d.attribute === 'B') return 'var(--color-attr-b)';
                        if (d.attribute === 'C') return 'var(--color-attr-c)';
                    }
                    return 'var(--color-gray)';
                });
            } else {
                anonElements.nodes.attr('fill', d => {
                    return d.known ? 'var(--color-blue)' : 'var(--color-gray)';
                });
            }
            
            updateInfoDisplay();
        }
        
        function toggleAnimation() {
            if (!currentMethod) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¼”ç¤ºæ–¹æ³•ï¼');
                return;
            }
            
            isPlaying = !isPlaying;
            const btn = d3.select('#play-btn');
            
            if (isPlaying) {
                btn.text('â¸ æš‚åœ').classed('pause', true);
                startAnimation();
            } else {
                btn.text('â–¶ï¸ ç»§ç»­').classed('pause', false);
                clearInterval(animationInterval);
            }
        }
        
        function resetAnimation() {
            isPlaying = false;
            currentStep = 0;
            clearInterval(animationInterval);
            d3.select('#play-btn').text('â–¶ï¸ å¼€å§‹æ¼”ç¤º').classed('pause', false);
            d3.select('#anim-status').style('display', 'none');
            resetGraphVisualization();
        }
        
        function startAnimation() {
            const animations = {
                greedy: animateGreedy,
                hungarian: animateHungarian,
                graph_kernel: animateGraphKernel,
                deepwalk: animateDeepWalk,
                attribute: animateAttribute,
                label_propagation: animateLabelPropagation,
                graphsage: animateGraphSAGE,
                defense: animateDefense,
                k_anonymity: animateKAnonymity,
                noise_injection: animateNoiseInjection
            };
            
            const animFunc = animations[currentMethod];
            if (animFunc) {
                animFunc();
            }
        }
        
        // ========== è´ªå¿ƒåŒ¹é…åŠ¨ç”» ==========
        function animateGreedy() {
            const steps = DATA.animations.greedy;
            if (!steps || steps.length === 0) return;
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = steps.length;
            successCount = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            
            animationInterval = setInterval(() => {
                if (currentStep >= steps.length) {
                    isPlaying = false;
                    clearInterval(animationInterval);
                    d3.select('#play-btn').text('âœ“ å®Œæˆ').classed('pause', false);
                    d3.select('#anim-status').text('åŒ¹é…å®Œæˆï¼');
                    return;
                }
                
                const step = steps[currentStep];
                d3.select('#anim-status').text(`æ­¥éª¤ ${currentStep + 1}/${steps.length}: ${step.description}`);
                
                // é«˜äº®åŸå§‹å›¾èŠ‚ç‚¹ï¼ˆå‡è®¾éƒ½åŒ¹é…æˆåŠŸï¼Œç”¨ç»¿è‰²è¾¹æ¡†ï¼‰
                origElements.nodes
                    .classed('highlighted', d => d.index === step.orig_node)
                    .classed('matched-success', function(d) {
                        const wasMatched = d3.select(this).classed('matched-success');
                        return wasMatched || d.index === step.orig_node;
                    });
                
                // é«˜äº®åŒ¿åå›¾èŠ‚ç‚¹
                anonElements.nodes
                    .classed('highlighted', d => d.index === step.anon_node)
                    .classed('matched-success', function(d) {
                        const wasMatched = d3.select(this).classed('matched-success');
                        return wasMatched || d.index === step.anon_node;
                    });
                
                // ä¸ç»˜åˆ¶è¿çº¿ï¼Œåªé«˜äº®èŠ‚ç‚¹
                
                // æ›´æ–°ç»Ÿè®¡ï¼ˆå‡è®¾90%åŒ¹é…æˆåŠŸï¼‰
                if (Math.random() > 0.1) {
                    successCount++;
                }
                
                currentStep++;
                updateInfoDisplay();
                
            }, 2000); // æ¯2ç§’ä¸€æ­¥
        }
        
        // ========== åŒˆç‰™åˆ©ç®—æ³•åŠ¨ç”» ==========
        function animateHungarian() {
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = 1;
            currentStep = 0;
            successCount = 0;
            
            d3.select('#anim-status').style('display', 'block').text('åŒˆç‰™åˆ©ç®—æ³•ï¼šè®¡ç®—å…¨å±€æœ€ä¼˜åŒ¹é…...');
            updateInfoDisplay();
            
            setTimeout(() => {
                // ä¸€æ¬¡æ€§æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…
                const steps = DATA.animations.greedy; // ä½¿ç”¨ç›¸åŒæ•°æ®æ¼”ç¤º
                successCount = steps.length;
                
                steps.forEach(step => {
                    origElements.nodes.filter(d => d.index === step.orig_node).classed('matched-success', true);
                    anonElements.nodes.filter(d => d.index === step.anon_node).classed('matched-success', true);
                });
                
                d3.select('#anim-status').text('å…¨å±€æœ€ä¼˜åŒ¹é…å®Œæˆï¼');
                d3.select('#play-btn').text('âœ“ å®Œæˆ').classed('pause', false);
                isPlaying = false;
                clearInterval(animationInterval);
                
                currentStep = steps.length;
                updateInfoDisplay();
            }, 1500);
        }
        
        // ========== å›¾æ ¸æ–¹æ³•åŠ¨ç”» ==========
        function animateGraphKernel() {
            const kernelData = DATA.animations.graph_kernel;
            if (!kernelData) return;
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = 3; // æå–å­å›¾ã€è®¡ç®—æ ¸ã€åŒ¹é…
            currentStep = 0;
            successCount = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            let step = 0;
            
            animationInterval = setInterval(() => {
                if (step === 0) {
                    // é«˜äº®ä¸­å¿ƒèŠ‚ç‚¹
                    d3.select('#anim-status').text('é€‰æ‹©ä¸­å¿ƒèŠ‚ç‚¹è¿›è¡Œå­å›¾æå–');
                    currentStep = 1;
                    updateInfoDisplay();
                    origElements.nodes.filter(d => d.index === kernelData.center_node)
                        .classed('highlighted', true);
                    anonElements.nodes.filter(d => d.index === kernelData.center_node)
                        .classed('highlighted', true);
                } else if (step === 1) {
                    // é«˜äº®1-hopé‚»å±…
                    d3.select('#anim-status').text('æå–1-hopé‚»å±…å­å›¾');
                    const neighbors = kernelData.hops[0].nodes;
                    origElements.links.classed('highlighted', l => 
                        l.source.index === kernelData.center_node || l.target.index === kernelData.center_node
                    );
                    currentStep = 2;
                    updateInfoDisplay();
                } else if (step === 2) {
                    // WLæ ¸è¿­ä»£
                    d3.select('#anim-status').text('WLæ ¸è¿­ä»£æ›´æ–°æ ‡ç­¾...');
                    currentStep = 3;
                    successCount = 8; // æ¨¡æ‹ŸåŒ¹é…æˆåŠŸæ•°
                    updateInfoDisplay();
                } else {
                    d3.select('#anim-status').text('å­å›¾æ¯”è¾ƒå®Œæˆï¼');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                }
                
                step++;
            }, 2000);
        }
        
        // ========== DeepWalkåŠ¨ç”» ==========
        function animateDeepWalk() {
            const walks = DATA.animations.deepwalk.walks;
            if (!walks || walks.length === 0) return;
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            let totalWalkSteps = walks.reduce((sum, walk) => sum + walk.length, 0);
            totalSteps = totalWalkSteps;
            currentStep = 0;
            successCount = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            let walkIdx = 0;
            let stepIdx = 0;
            
            animationInterval = setInterval(() => {
                if (walkIdx >= walks.length) {
                    d3.select('#anim-status').text('éšæœºæ¸¸èµ°é‡‡æ ·å®Œæˆï¼');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    return;
                }
                
                const walk = walks[walkIdx];
                
                if (stepIdx === 0) {
                    // é‡ç½®
                    origElements.nodes.classed('highlighted', false);
                    origElements.links.classed('walk-path', false);
                }
                
                if (stepIdx < walk.length) {
                    d3.select('#anim-status').text(`éšæœºæ¸¸èµ° ${walkIdx + 1}/${walks.length} - æ­¥éª¤ ${stepIdx + 1}/${walk.length}`);
                    
                    // é«˜äº®å½“å‰èŠ‚ç‚¹
                    origElements.nodes.classed('highlighted', d => d.index === walk[stepIdx]);
                    
                    // é«˜äº®è·¯å¾„è¾¹
                    if (stepIdx > 0) {
                        origElements.links.classed('walk-path', l => 
                            (l.source.index === walk[stepIdx-1] && l.target.index === walk[stepIdx]) ||
                            (l.target.index === walk[stepIdx-1] && l.source.index === walk[stepIdx])
                        );
                    }
                    
                    stepIdx++;
                    currentStep++;
                    if (stepIdx === walk.length) successCount++; // æ¯å®Œæˆä¸€æ¡æ¸¸èµ°ç®—ä¸€ä¸ªæˆåŠŸ
                    updateInfoDisplay();
                } else {
                    // ä¸‹ä¸€æ¡æ¸¸èµ°
                    walkIdx++;
                    stepIdx = 0;
                }
                
            }, 500); // æ¯0.5ç§’ä¸€æ­¥
        }
        
        // ========== å±æ€§æ¨æ–­åŠ¨ç”» ==========
        function animateAttribute() {
            const inferenceSteps = DATA.animations.attribute_inference;
            if (!inferenceSteps || inferenceSteps.length === 0) return;
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = inferenceSteps.length;
            inferredCount = 0;
            
            // å…ˆè®¾ç½®å±æ€§é¢œè‰²
            anonElements.nodes.attr('fill', d => {
                if (d.known) {
                    if (d.attribute === 'A') return 'var(--color-attr-a)';
                    if (d.attribute === 'B') return 'var(--color-attr-b)';
                    if (d.attribute === 'C') return 'var(--color-attr-c)';
                }
                return 'var(--color-gray)';
            });
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            
            animationInterval = setInterval(() => {
                if (currentStep >= inferenceSteps.length) {
                    d3.select('#anim-status').text('å±æ€§æ¨æ–­å®Œæˆï¼');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    return;
                }
                
                const step = inferenceSteps[currentStep];
                d3.select('#anim-status').text(
                    `æ¨æ–­èŠ‚ç‚¹ ${step.node}: æŠ•ç¥¨ç»“æœ ${JSON.stringify(step.votes)} â†’ ${step.predicted}`
                );
                
                // é«˜äº®ç›®æ ‡èŠ‚ç‚¹å’Œé‚»å±…
                anonElements.nodes.classed('highlighted', d => 
                    d.index === step.node || step.neighbors.includes(d.index)
                );
                
                // é«˜äº®è¿æ¥è¾¹
                anonElements.links.classed('highlighted', l =>
                    (l.source.index === step.node && step.neighbors.includes(l.target.index)) ||
                    (l.target.index === step.node && step.neighbors.includes(l.source.index))
                );
                
                // æ›´æ–°èŠ‚ç‚¹é¢œè‰²å’Œå±æ€§
                setTimeout(() => {
                    anonElements.nodes.filter(d => d.index === step.node)
                        .each(function(d) {
                            // æ›´æ–°æ•°æ®ä¸­çš„å±æ€§
                            d.attribute = step.predicted;
                            d.known = true;
                        })
                        .transition()
                        .duration(800)
                        .attr('fill', () => {
                            if (step.predicted === 'A') return 'var(--color-attr-a)';
                            if (step.predicted === 'B') return 'var(--color-attr-b)';
                            if (step.predicted === 'C') return 'var(--color-attr-c)';
                            return 'var(--color-gray)';
                        })
                        .on('end', function() {
                            // ç”¨è¾¹æ¡†é«˜äº®è¡¨ç¤ºæ¨æ–­æˆåŠŸï¼ˆè“è‰²è¾¹æ¡†ï¼Œé¿å…å’Œå±æ€§é¢œè‰²å†²çªï¼‰
                            d3.select(this)
                                .style('stroke', 'var(--color-blue)')
                                .style('stroke-width', '4px')
                                .style('filter', 'drop-shadow(0 0 6px var(--color-blue))');
                            
                            // æ›´æ–°ç»Ÿè®¡
                            inferredCount++;
                            updateInfoDisplay();
                        });
                }, 1000);
                
                currentStep++;
                updateInfoDisplay();
                
            }, 2500); // æ¯2.5ç§’ä¸€æ­¥
        }
        
        // ========== å·®åˆ†éšç§é˜²å¾¡åŠ¨ç”» ==========
        function animateDefense() {
            const defenseData = DATA.animations.defense;
            if (!defenseData) return;
            
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = defenseData.edges_to_remove.length + defenseData.edges_to_add.length;
            currentStep = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            let phase = 0; // 0: åˆ è¾¹, 1: åŠ è¾¹
            let edgeIdx = 0;
            
            animationInterval = setInterval(() => {
                if (phase === 0) {
                    // åˆ è¾¹é˜¶æ®µ
                    if (edgeIdx < defenseData.edges_to_remove.length) {
                        d3.select('#anim-status').text(
                            `åˆ é™¤è¾¹ ${edgeIdx + 1}/${defenseData.edges_to_remove.length}`
                        );
                        
                        const idx = defenseData.edges_to_remove[edgeIdx];
                        anonElements.links.filter((d, i) => i === idx)
                            .classed('removed', true)
                            .transition()
                            .duration(500)
                            .attr('stroke-opacity', 0.3);
                        
                        edgeIdx++;
                        currentStep++;
                        updateInfoDisplay();
                    } else {
                        phase = 1;
                        edgeIdx = 0;
                    }
                } else {
                    // åŠ è¾¹é˜¶æ®µ
                    if (edgeIdx < defenseData.edges_to_add.length) {
                        d3.select('#anim-status').text(
                            `æ·»åŠ å™ªå£°è¾¹ ${edgeIdx + 1}/${defenseData.edges_to_add.length}`
                        );
                        
                        const edge = defenseData.edges_to_add[edgeIdx];
                        const sourceNode = DATA.graph.nodes.find(n => n.index === edge.source);
                        const targetNode = DATA.graph.nodes.find(n => n.index === edge.target);
                        
                        if (sourceNode && targetNode) {
                            anonElements.g.append('line')
                                .attr('class', 'link added')
                                .attr('x1', sourceNode.x)
                                .attr('y1', sourceNode.y)
                                .attr('x2', targetNode.x)
                                .attr('y2', targetNode.y)
                                .attr('stroke-opacity', 0)
                                .transition()
                                .duration(500)
                                .attr('stroke-opacity', 0.7);
                        }
                        
                        edgeIdx++;
                        currentStep++;
                        updateInfoDisplay();
                    } else {
                        d3.select('#anim-status').text('è¾¹æ‰°åŠ¨å®Œæˆï¼');
                        d3.select('#play-btn').text('âœ“ å®Œæˆ');
                        isPlaying = false;
                        clearInterval(animationInterval);
                    }
                }
                
            }, 800); // æ¯0.8ç§’ä¸€æ¡è¾¹
        }
        
        // ========== æ ‡ç­¾ä¼ æ’­åŠ¨ç”» ==========
        function animateLabelPropagation() {
            // åˆå§‹åŒ–ç»Ÿè®¡
            const maxIterations = 5;
            totalSteps = maxIterations;
            currentStep = 0;
            inferredCount = 0;
            
            d3.select('#anim-status').style('display', 'block').text('æ ‡ç­¾ä¼ æ’­ï¼šè¿­ä»£æ‰©æ•£ä¸­...');
            updateInfoDisplay();
            
            // å…ˆè®¾ç½®åˆå§‹å±æ€§é¢œè‰²
            anonElements.nodes.attr('fill', d => {
                if (d.known) {
                    if (d.attribute === 'A') return 'var(--color-attr-a)';
                    if (d.attribute === 'B') return 'var(--color-attr-b)';
                    if (d.attribute === 'C') return 'var(--color-attr-c)';
                }
                return 'var(--color-gray)';
            });
            
            let iteration = 0;
            
            animationInterval = setInterval(() => {
                if (iteration >= maxIterations) {
                    d3.select('#anim-status').text('æ ‡ç­¾ä¼ æ’­å®Œæˆï¼');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    return;
                }
                
                d3.select('#anim-status').text(`è¿­ä»£ ${iteration + 1}/${maxIterations}: æ ‡ç­¾æ‰©æ•£ä¸­...`);
                
                // æ¨¡æ‹Ÿæ ‡ç­¾ä¼ æ’­ï¼šæ¯æ¬¡è¿­ä»£éšæœºé€‰æ‹©ä¸€äº›æœªçŸ¥èŠ‚ç‚¹è¿›è¡Œæ¨æ–­
                const unknownNodes = DATA.graph.nodes.filter(d => !d.known);
                const nodesToInfer = unknownNodes.slice(iteration * 3, (iteration + 1) * 3);
                
                nodesToInfer.forEach((node, idx) => {
                    setTimeout(() => {
                        // æ¨¡æ‹Ÿé€šè¿‡é‚»å±…è·å¾—å±æ€§
                        const attrs = ['A', 'B', 'C'];
                        const predictedAttr = attrs[node.index % 3];
                        
                        anonElements.nodes.filter(d => d.index === node.index)
                            .each(function(d) {
                                d.attribute = predictedAttr;
                                d.known = true;
                            })
                            .transition()
                            .duration(600)
                            .attr('fill', () => {
                                if (predictedAttr === 'A') return 'var(--color-attr-a)';
                                if (predictedAttr === 'B') return 'var(--color-attr-b)';
                                if (predictedAttr === 'C') return 'var(--color-attr-c)';
                            })
                            .on('end', function() {
                                d3.select(this)
                                    .style('stroke', 'var(--color-blue)')
                                    .style('stroke-width', '4px');
                                
                                // æ›´æ–°ç»Ÿè®¡
                                inferredCount++;
                                updateInfoDisplay();
                            });
                    }, idx * 400);
                });
                
                currentStep++;
                iteration++;
                updateInfoDisplay();
            }, 2000);
        }
        
        // ========== GraphSAGEåŠ¨ç”» ==========
        function animateGraphSAGE() {
            // åˆå§‹åŒ–ç»Ÿè®¡
            const maxLayers = 3;
            totalSteps = maxLayers;
            currentStep = 0;
            inferredCount = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            
            // å…ˆè®¾ç½®åˆå§‹å±æ€§é¢œè‰²
            anonElements.nodes.attr('fill', d => {
                if (d.known) {
                    if (d.attribute === 'A') return 'var(--color-attr-a)';
                    if (d.attribute === 'B') return 'var(--color-attr-b)';
                    if (d.attribute === 'C') return 'var(--color-attr-c)';
                }
                return 'var(--color-gray)';
            });
            
            let layer = 0;
            
            animationInterval = setInterval(() => {
                if (layer >= maxLayers) {
                    d3.select('#anim-status').text('GraphSAGEèšåˆå®Œæˆï¼');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    return;
                }
                
                d3.select('#anim-status').text(`Layer ${layer + 1}/${maxLayers}: èšåˆ${layer + 1}-hopé‚»å±…ç‰¹å¾...`);
                
                // é«˜äº®æ˜¾ç¤ºå½“å‰å±‚çš„èšåˆèŒƒå›´ï¼ˆæ¨¡æ‹Ÿï¼‰
                const sampleNode = layer * 5 % DATA.graph.nodes.length;
                anonElements.nodes.classed('highlighted', d => {
                    // ç®€åŒ–ï¼šé«˜äº®ä¸€äº›èŠ‚ç‚¹è¡¨ç¤ºæ­£åœ¨èšåˆ
                    return Math.abs(d.index - sampleNode) <= layer + 1;
                });
                
                setTimeout(() => {
                    anonElements.nodes.classed('highlighted', false);
                    // æ¨¡æ‹Ÿæ¯å±‚èšåˆæ¨æ–­ä¸€äº›èŠ‚ç‚¹
                    inferredCount += 3;
                    updateInfoDisplay();
                }, 1500);
                
                currentStep++;
                layer++;
                updateInfoDisplay();
            }, 2000);
        }
        
        // ========== k-åŒ¿ååŒ–åŠ¨ç”» ==========
        function animateKAnonymity() {
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = 5; // 5ä¸ªé˜¶æ®µ
            currentStep = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            let phase = 0;
            
            animationInterval = setInterval(() => {
                if (phase === 0) {
                    d3.select('#anim-status').text('åˆ†æåº¦æ•°åˆ†å¸ƒ...');
                    // é«˜äº®ä¸åŒåº¦æ•°çš„èŠ‚ç‚¹
                    anonElements.nodes
                        .transition()
                        .duration(800)
                        .attr('r', d => Math.max(8, Math.sqrt(d.degree) * 3))
                        .style('opacity', 0.8);
                    currentStep++;
                    updateInfoDisplay();
                } else if (phase === 1) {
                    d3.select('#anim-status').text('è¯†åˆ«åº¦æ•°ç‹¬ç‰¹çš„èŠ‚ç‚¹ï¼ˆéœ€è¦åŒ¿ååŒ–ï¼‰...');
                    // é«˜äº®åº¦æ•°ç‹¬ç‰¹çš„èŠ‚ç‚¹
                    anonElements.nodes.classed('highlighted', d => d.degree > 10 || d.degree < 3);
                    currentStep++;
                    updateInfoDisplay();
                } else if (phase === 2) {
                    d3.select('#anim-status').text('æ·»åŠ è¾¹ä»¥å¢åŠ åº¦æ•°...');
                    // æ·»åŠ ä¸€äº›ç»¿è‰²è™šçº¿è¾¹
                    for (let i = 0; i < 10; i++) {
                        const idx1 = Math.floor(Math.random() * DATA.graph.nodes.length);
                        const idx2 = Math.floor(Math.random() * DATA.graph.nodes.length);
                        if (idx1 !== idx2) {
                            const n1 = DATA.graph.nodes[idx1];
                            const n2 = DATA.graph.nodes[idx2];
                            if (n1 && n2) {
                                anonElements.g.append('line')
                                    .attr('class', 'link added')
                                    .attr('x1', n1.x)
                                    .attr('y1', n1.y)
                                    .attr('x2', n2.x)
                                    .attr('y2', n2.y)
                                    .attr('opacity', 0)
                                    .transition()
                                    .duration(500)
                                    .attr('opacity', 0.7);
                            }
                        }
                    }
                    currentStep++;
                    updateInfoDisplay();
                } else if (phase === 3) {
                    d3.select('#anim-status').text('åˆ é™¤è¾¹ä»¥é™ä½åº¦æ•°...');
                    // æ ‡è®°ä¸€äº›è¾¹ä¸ºåˆ é™¤
                    anonElements.links
                        .filter((d, i) => i % 5 === 0)
                        .classed('removed', true)
                        .transition()
                        .duration(500)
                        .attr('opacity', 0.3);
                    currentStep++;
                    updateInfoDisplay();
                } else {
                    d3.select('#anim-status').text('k-åŒ¿ååŒ–å®Œæˆï¼åº¦æ•°åˆ†å¸ƒå·²å¹³æ»‘');
                    anonElements.nodes.classed('highlighted', false);
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    currentStep++;
                    updateInfoDisplay();
                }
                
                phase++;
            }, 2000);
        }
        
        // ========== å™ªå£°æ³¨å…¥åŠ¨ç”» ==========
        function animateNoiseInjection() {
            // åˆå§‹åŒ–ç»Ÿè®¡
            totalSteps = 3; // 3ä¸ªé˜¶æ®µ
            currentStep = 0;
            
            d3.select('#anim-status').style('display', 'block');
            updateInfoDisplay();
            let phase = 0;
            
            animationInterval = setInterval(() => {
                if (phase === 0) {
                    d3.select('#anim-status').text('æ³¨å…¥è™šå‡èŠ‚ç‚¹...');
                    // æ·»åŠ ç´«è‰²çš„è™šå‡èŠ‚ç‚¹ï¼ˆåœ¨ç°æœ‰èŠ‚ç‚¹ä½ç½®é™„è¿‘ï¼‰
                    const fakeNodes = [];
                    for (let i = 0; i < 8; i++) {
                        const baseNode = DATA.graph.nodes[i];
                        fakeNodes.push({
                            x: baseNode.x + (Math.random() - 0.5) * 100,
                            y: baseNode.y + (Math.random() - 0.5) * 100,
                            fake: true
                        });
                    }
                    
                    anonElements.g.selectAll('.fake-node')
                        .data(fakeNodes)
                        .join('circle')
                        .attr('class', 'fake-node node')
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y)
                        .attr('r', 0)
                        .attr('fill', '#9C27B0')
                        .attr('opacity', 0)
                        .transition()
                        .duration(800)
                        .attr('r', 8)
                        .attr('opacity', 0.7);
                    
                    currentStep++;
                    updateInfoDisplay();
                        
                } else if (phase === 1) {
                    d3.select('#anim-status').text('æ³¨å…¥è™šå‡è¾¹...');
                    // æ·»åŠ é»„è‰²è™šçº¿è¾¹
                    for (let i = 0; i < 15; i++) {
                        const idx1 = Math.floor(Math.random() * DATA.graph.nodes.length);
                        const idx2 = Math.floor(Math.random() * DATA.graph.nodes.length);
                        if (idx1 !== idx2) {
                            const n1 = DATA.graph.nodes[idx1];
                            const n2 = DATA.graph.nodes[idx2];
                            if (n1 && n2) {
                                anonElements.g.append('line')
                                    .attr('x1', n1.x)
                                    .attr('y1', n1.y)
                                    .attr('x2', n2.x)
                                    .attr('y2', n2.y)
                                    .attr('stroke', '#FFC107')
                                    .attr('stroke-width', 2)
                                    .attr('stroke-dasharray', '5,5')
                                    .attr('opacity', 0)
                                    .transition()
                                    .duration(500)
                                    .attr('opacity', 0.6);
                            }
                        }
                    }
                    currentStep++;
                    updateInfoDisplay();
                } else if (phase === 2) {
                    d3.select('#anim-status').text('æ‰°åŠ¨å®Œæˆï¼æ”»å‡»è€…éš¾ä»¥åŒºåˆ†çœŸå‡');
                    d3.select('#play-btn').text('âœ“ å®Œæˆ');
                    isPlaying = false;
                    clearInterval(animationInterval);
                    currentStep++;
                    updateInfoDisplay();
                }
                
                phase++;
            }, 2500);
        }
        
        // å…¨å±€ç»Ÿè®¡å˜é‡
        let totalSteps = 0;
        let successCount = 0;
        let inferredCount = 0;
        
        function updateInfoDisplay() {
            const infoGrid = document.getElementById('info-display');
            
            // æ ¹æ®ä¸åŒé˜¶æ®µå’Œæ–¹æ³•æ˜¾ç¤ºä¸åŒçš„ç»Ÿè®¡ä¿¡æ¯
            let statLabel = '';
            let statValue = 0;
            
            if (currentStage === 1) {
                // é˜¶æ®µä¸€ï¼šèº«ä»½å»åŒ¿ååŒ–
                statLabel = 'åŒ¹é…æˆåŠŸ';
                statValue = successCount;
            } else if (currentStage === 2) {
                // é˜¶æ®µäºŒï¼šå±æ€§æ¨æ–­
                statLabel = 'å·²æ¨æ–­';
                statValue = inferredCount;
            } else if (currentStage === 3) {
                // é˜¶æ®µä¸‰ï¼šé˜²å¾¡
                statLabel = 'æ‰°åŠ¨è¾¹æ•°';
                statValue = currentStep;
            }
            
            // è®¡ç®—å®Œæˆåº¦
            let progress = totalSteps > 0 ? ((currentStep / totalSteps) * 100).toFixed(0) : 0;
            
            infoGrid.innerHTML = `
                <div class="info-item">
                    <div class="info-value">${DATA.meta.nodes}</div>
                    <div class="info-label">èŠ‚ç‚¹æ•°</div>
                </div>
                <div class="info-item">
                    <div class="info-value">${currentStep}/${totalSteps}</div>
                    <div class="info-label">å½“å‰æ­¥éª¤</div>
                </div>
                <div class="info-item">
                    <div class="info-value">${statValue}</div>
                    <div class="info-label">${statLabel}</div>
                </div>
                <div class="info-item">
                    <div class="info-value">${progress}%</div>
                    <div class="info-label">å®Œæˆåº¦</div>
                </div>
            `;
        }
    </script>
</body>
</html>

