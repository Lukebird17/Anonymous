<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>D3 ForceLink 测试</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        svg { border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>D3 ForceLink 测试</h1>
    <div id="status"></div>
    <svg width="600" height="400"></svg>
    
    <script>
        const status = document.getElementById('status');
        
        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = msg;
            status.appendChild(div);
        }
        
        // 加载真实数据
        d3.json('real_data_demo.json')
            .then(data => {
                log('✅ 数据加载成功');
                log(`节点数: ${data.graph.nodes.length}, 边数: ${data.graph.links.length}`);
                
                // 检查节点ID
                const nodeIds = data.graph.nodes.map(d => d.id);
                log(`节点ID样本: ${nodeIds.slice(0, 5).join(', ')}`);
                
                // 检查边
                const firstLink = data.graph.links[0];
                log(`第一条边: ${firstLink.source} -> ${firstLink.target}`);
                
                // 测试forceLink
                try {
                    const nodes = data.graph.nodes.slice();  // 复制数组
                    const links = data.graph.links.slice();
                    
                    const simulation = d3.forceSimulation(nodes)
                        .force('link', d3.forceLink(links)
                            .id(d => d.id)  // 使用id
                            .distance(50))
                        .force('charge', d3.forceManyBody().strength(-100))
                        .force('center', d3.forceCenter(300, 200))
                        .stop();
                    
                    // 运行几步模拟
                    for (let i = 0; i < 10; i++) {
                        simulation.tick();
                    }
                    
                    log('✅ ForceLink 初始化成功');
                    log(`节点位置样本: x=${nodes[0].x.toFixed(2)}, y=${nodes[0].y.toFixed(2)}`);
                    
                    // 绘制图形
                    const svg = d3.select('svg');
                    
                    // 绘制边
                    const link = svg.append('g')
                        .selectAll('line')
                        .data(links)
                        .join('line')
                        .attr('stroke', '#999')
                        .attr('stroke-width', 1);
                    
                    // 绘制节点
                    const node = svg.append('g')
                        .selectAll('circle')
                        .data(nodes)
                        .join('circle')
                        .attr('r', 5)
                        .attr('fill', '#69b3a2');
                    
                    // 更新位置
                    simulation.on('tick', () => {
                        link
                            .attr('x1', d => d.source.x)
                            .attr('y1', d => d.source.y)
                            .attr('x2', d => d.target.x)
                            .attr('y2', d => d.target.y);
                        
                        node
                            .attr('cx', d => d.x)
                            .attr('cy', d => d.y);
                    });
                    
                    simulation.restart();
                    
                    log('✅ 图形绘制成功');
                    
                } catch (error) {
                    log('❌ ForceLink 错误: ' + error.message, true);
                    console.error(error);
                }
            })
            .catch(err => {
                log('❌ 数据加载失败: ' + err.message, true);
                console.error(err);
            });
    </script>
</body>
</html>





