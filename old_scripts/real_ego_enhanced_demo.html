<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Egoç½‘ç»œæ”»å‡»é˜²å¾¡æ¼”ç¤ºç³»ç»Ÿ - çœŸå®æ•°æ®ç‰ˆ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        /* è“æ©™é…è‰² */
        :root {
            --color-primary: #2196F3;
            --color-secondary: #FF9800;
            --color-success: #4CAF50;
            --color-danger: #f44336;
        }
        
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5em;
            color: #333;
        }
        
        .header .stats {
            font-size: 0.9em;
            color: #666;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        /* å·¦ä¾§ 65% */
        .left-panel {
            flex: 0 0 65%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .viz-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .viz-card.large {
            flex: 1.5;
            min-height: 400px;
        }
        
        .viz-card.small {
            flex: 1;
            min-height: 250px;
        }
        
        .viz-card h3 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .viz-card .viz-content {
            flex: 1;
            position: relative;
        }
        
        /* å³ä¾§æ§åˆ¶é¢æ¿ 35% */
        .control-panel {
            flex: 0 0 35%;
            background: #fafafa;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 15px;
        }
        
        .control-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .control-card h3 {
            font-size: 1em;
            color: #555;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        /* é˜¶æ®µæ ‡ç­¾é¡µ */
        .stage-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .stage-tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s;
            text-align: center;
        }
        
        .stage-tab:hover {
            background: #e0e0e0;
        }
        
        .stage-tab.active {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        /* æ–¹æ³•æŒ‰é’® */
        .method-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .method-btn {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            text-align: left;
            transition: all 0.3s;
            position: relative;
        }
        
        .method-btn:hover {
            border-color: var(--color-primary);
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .method-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .method-btn .accuracy {
            float: right;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* åŸç†è¯´æ˜ */
        .principle-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.7;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .principle-box h4 {
            color: var(--color-primary);
            margin: 15px 0 8px 0;
            font-size: 1em;
        }
        
        .principle-box .step {
            margin: 10px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .principle-box .step::before {
            content: "â–¶";
            position: absolute;
            left: 0;
            color: var(--color-secondary);
        }
        
        .formula {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 4px solid var(--color-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* å›¾å¯è§†åŒ– */
        svg {
            width: 100%;
            height: 100%;
        }
        
        .node {
            stroke: white;
            stroke-width: 2.5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .node:hover {
            stroke: var(--color-secondary);
            stroke-width: 4px;
        }
        
        .node.highlighted {
            stroke: var(--color-secondary);
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px var(--color-secondary));
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .node.matched {
            stroke: var(--color-success);
            stroke-width: 4px;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.4;
            stroke-width: 1px;
        }
        
        .link.highlighted {
            stroke: var(--color-secondary);
            stroke-width: 3px;
            stroke-opacity: 0.8;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -10; }
        }
        
        .node-label {
            font-size: 9px;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            fill: #333;
        }
        
        /* æç¤ºæ¡† */
        .tooltip {
            position: absolute;
            padding: 10px 12px;
            background: rgba(0,0,0,0.85);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .ctrl-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .ctrl-btn.play {
            background: var(--color-primary);
            color: white;
        }
        
        .ctrl-btn.play:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .ctrl-btn.reset {
            background: #e0e0e0;
        }
        
        .ctrl-btn.reset:hover {
            background: #bdbdbd;
        }
        
        /* ç»“æœç»Ÿè®¡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        /* å›¾å¯¹æ¯”å®¹å™¨ */
        .graph-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 100%;
        }
        
        .graph-pane {
            display: flex;
            flex-direction: column;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .graph-pane h4 {
            background: #f8f9fa;
            padding: 10px;
            margin: 0;
            font-size: 0.95em;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .graph-pane.original h4 {
            background: #e3f2fd;
            color: var(--color-primary);
        }
        
        .graph-pane.anon h4 {
            background: #fff3e0;
            color: var(--color-secondary);
        }
        
        .graph-svg-container {
            flex: 1;
            position: relative;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨Header -->
    <div class="header">
        <h1>ğŸ” Facebook Egoç½‘ç»œæ”»å‡»é˜²å¾¡æ¼”ç¤ºç³»ç»Ÿ</h1>
        <div class="stats">
            <span id="graph-stats">åŠ è½½ä¸­...</span>
        </div>
    </div>
    
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <!-- å›¾å¯¹æ¯”å¯è§†åŒ– -->
            <div class="viz-card large">
                <h3>
                    <span id="top-title">å›¾ç½‘ç»œå¯è§†åŒ–</span>
                    <span id="zoom-controls" style="font-size: 0.85em; color: #999;">
                        ä½¿ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾ | æ‹–æ‹½ç§»åŠ¨
                    </span>
                </h3>
                <div class="viz-content" id="top-viz">
                    <div class="graph-compare">
                        <div class="graph-pane original">
                            <h4>ğŸ”µ åŸå§‹å›¾ (Original)</h4>
                            <div class="graph-svg-container">
                                <svg id="graph-orig-svg"></svg>
                            </div>
                        </div>
                        <div class="graph-pane anon">
                            <h4>ğŸŸ  åŒ¿åå›¾ (Anonymized)</h4>
                            <div class="graph-svg-container">
                                <svg id="graph-anon-svg"></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®/çŸ©é˜µå¯è§†åŒ– -->
            <div class="viz-card small">
                <h3 id="bottom-title">æ–¹æ³•è¯¦ç»†ä¿¡æ¯</h3>
                <div class="viz-content" id="bottom-viz">
                    <p style="text-align: center; color: #999; padding: 50px;">
                        é€‰æ‹©ä¸€ä¸ªæ”»å‡»/é˜²å¾¡æ–¹æ³•æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                    </p>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <!-- é˜¶æ®µé€‰æ‹© -->
            <div class="control-card">
                <h3>ğŸ¯ é€‰æ‹©é˜¶æ®µ</h3>
                <div class="stage-tabs">
                    <button class="stage-tab active" data-stage="1">
                        é˜¶æ®µä¸€<br><small>èº«ä»½å»åŒ¿ååŒ–</small>
                    </button>
                    <button class="stage-tab" data-stage="2">
                        é˜¶æ®µäºŒ<br><small>å±æ€§æ¨æ–­</small>
                    </button>
                    <button class="stage-tab" data-stage="3">
                        é˜¶æ®µä¸‰<br><small>é²æ£’æ€§æµ‹è¯•</small>
                    </button>
                    <button class="stage-tab" data-stage="4">
                        é˜¶æ®µå››<br><small>å·®åˆ†éšç§é˜²å¾¡</small>
                    </button>
                </div>
            </div>
            
            <!-- æ–¹æ³•é€‰æ‹© -->
            <div class="control-card">
                <h3>ğŸ”¬ æ”»å‡»/é˜²å¾¡æ–¹æ³•</h3>
                <div class="method-grid" id="method-selector">
                    <p style="text-align: center; color: #999;">
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé˜¶æ®µ
                    </p>
                </div>
            </div>
            
            <!-- åŸç†è¯´æ˜ -->
            <div class="control-card">
                <h3>ğŸ“– æ–¹æ³•åŸç†</h3>
                <div class="principle-box" id="principle-content">
                    <p style="text-align: center; color: #999;">
                        é€‰æ‹©æ–¹æ³•åæŸ¥çœ‹è¯¦ç»†åŸç†
                    </p>
                </div>
            </div>
            
            <!-- å®éªŒç»“æœ -->
            <div class="control-card">
                <h3>ğŸ“Š å®éªŒç»“æœ</h3>
                <div id="results-display">
                    <p style="text-align: center; color: #999;">
                        é€‰æ‹©æ–¹æ³•åæŸ¥çœ‹å®éªŒç»“æœ
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let DATA = null;
        let currentStage = 1;
        let currentMethod = null;
        let origGraphElements = null;
        let anonGraphElements = null;
        
        // åŠ è½½çœŸå®æ•°æ®
        d3.json('real_ego_demo_data.json').then(data => {
            DATA = data;
            console.log('âœ… çœŸå®æ•°æ®åŠ è½½æˆåŠŸ:', data.meta);
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('graph-stats').innerHTML = `
                èŠ‚ç‚¹: <strong>${data.meta.nodes}</strong> | 
                è¾¹: <strong>${data.meta.edges}</strong> | 
                å¹³å‡åº¦: <strong>${data.meta.avg_degree.toFixed(2)}</strong>
            `;
            
            initializeUI();
        }).catch(err => {
            console.error('æ•°æ®åŠ è½½å¤±è´¥:', err);
            alert('æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶ real_ego_demo_data.jsonï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼');
        });
        
        function initializeUI() {
            // é˜¶æ®µåˆ‡æ¢
            d3.selectAll('.stage-tab').on('click', function() {
                const stage = parseInt(this.dataset.stage);
                selectStage(stage);
            });
            
            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªé˜¶æ®µ
            selectStage(1);
            
            // å…ˆæ¸²æŸ“å›¾ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
            renderTwoGraphs();
        }
        
        function selectStage(stage) {
            currentStage = stage;
            currentMethod = null;
            
            d3.selectAll('.stage-tab').classed('active', false);
            d3.select(`.stage-tab[data-stage="${stage}"]`).classed('active', true);
            
            renderMethodButtons();
        }
        
        function renderMethodButtons() {
            const methodSelector = d3.select('#method-selector');
            methodSelector.html('');
            
            if (!DATA || !DATA.real_results) return;
            
            if (currentStage === 1) {
                // èº«ä»½å»åŒ¿ååŒ–
                const methods = DATA.real_results.deanonymization.filter(m => m.level === 'æ¸©å’Œ');
                methods.forEach(m => {
                    methodSelector.append('button')
                        .attr('class', 'method-btn')
                        .html(`
                            ${m.method}
                            <span class="accuracy">${(m.accuracy * 100).toFixed(1)}%</span>
                        `)
                        .on('click', () => selectMethod(m.method, m));
                });
            } else if (currentStage === 2) {
                // å±æ€§æ¨æ–­
                const methods = DATA.real_results.attribute_inference || [];
                if (methods.length === 0) {
                    methodSelector.html('<p style="color: #999; text-align: center;">æš‚æ— å±æ€§æ¨æ–­æ•°æ®</p>');
                    return;
                }
                methods.forEach(m => {
                    methodSelector.append('button')
                        .attr('class', 'method-btn')
                        .html(`
                            ${m.method}
                            <span class="accuracy">${(m.accuracy * 100).toFixed(1)}%</span>
                        `)
                        .on('click', () => selectMethod(m.method, m));
                });
            } else if (currentStage === 3) {
                // é²æ£’æ€§æµ‹è¯•
                methodSelector.html(`
                    <button class="method-btn" onclick="showRobustness()">
                        æŸ¥çœ‹é²æ£’æ€§æµ‹è¯•ç»“æœ
                    </button>
                `);
            } else if (currentStage === 4) {
                // å·®åˆ†éšç§é˜²å¾¡
                methodSelector.html(`
                    <button class="method-btn" onclick="showDefense()">
                        æŸ¥çœ‹å·®åˆ†éšç§é˜²å¾¡æ•ˆæœ
                    </button>
                `);
            }
        }
        
        function selectMethod(methodName, methodData) {
            currentMethod = methodName;
            
            d3.selectAll('.method-btn').classed('active', false);
            d3.selectAll('.method-btn').filter(function() {
                return this.textContent.includes(methodName);
            }).classed('active', true);
            
            // æ˜¾ç¤ºåŸç†
            showPrinciple(methodName);
            
            // æ˜¾ç¤ºç»“æœ
            showResults(methodData);
            
            // æ›´æ–°åº•éƒ¨å¯è§†åŒ–
            updateBottomViz(methodName, methodData);
        }
        
        function showPrinciple(methodName) {
            const principles = {
                'Baseline-Greedy': `
                    <h4>è´ªå¿ƒç‰¹å¾åŒ¹é…åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1: ç‰¹å¾æå–</strong><br>
                        è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç»“æ„ç‰¹å¾ï¼šåº¦æ•°ã€èšç±»ç³»æ•°ã€ä¸‰è§’å½¢æ•°ã€k-coreå€¼ã€é‚»å±…åº¦æ•°åˆ†å¸ƒ
                    </div>
                    <div class="formula">
                        f(v) = [degree, clustering, triangles, k-core, ...]
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤2: ç›¸ä¼¼åº¦è®¡ç®—</strong><br>
                        å¯¹åŸå§‹å›¾å’ŒåŒ¿åå›¾çš„æ¯å¯¹èŠ‚ç‚¹è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
                    </div>
                    <div class="formula">
                        S[i,j] = cosine_similarity(f(v_i), f(v'_j))
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤3: è´ªå¿ƒåŒ¹é…</strong><br>
                        å¾ªç¯é€‰æ‹©ç›¸ä¼¼åº¦çŸ©é˜µä¸­çš„æœ€å¤§å€¼è¿›è¡ŒåŒ¹é…ï¼Œç›´åˆ°æ‰€æœ‰èŠ‚ç‚¹åŒ¹é…å®Œæˆ
                    </div>
                `,
                'Hungarian': `
                    <h4>åŒˆç‰™åˆ©ç®—æ³•åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1-2:</strong> ä¸è´ªå¿ƒæ–¹æ³•ç›¸åŒï¼Œæå–ç‰¹å¾å¹¶è®¡ç®—ç›¸ä¼¼åº¦
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤3: è½¬æ¢ä¸ºæˆæœ¬çŸ©é˜µ</strong><br>
                        C[i,j] = -S[i,j] æˆ– 1 - S[i,j]
                    </div>
                    <div class="formula">
                        æˆæœ¬çŸ©é˜µä¼˜åŒ–é—®é¢˜: min Î£ C[i, Ï€(i)]
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤4: åŒˆç‰™åˆ©ç®—æ³•æ±‚è§£</strong><br>
                        â€¢ è¡Œå½’çº¦ï¼šæ¯è¡Œå‡å»æœ€å°å€¼<br>
                        â€¢ åˆ—å½’çº¦ï¼šæ¯åˆ—å‡å»æœ€å°å€¼<br>
                        â€¢ æ‰¾é›¶å…ƒç´ è¦†ç›–<br>
                        â€¢ è¿­ä»£ç›´åˆ°æ‰¾åˆ°æœ€ä¼˜åŒ¹é…
                    </div>
                    <div class="step">
                        <strong>ä¼˜åŠ¿:</strong> å…¨å±€æœ€ä¼˜è§£ï¼ˆvs è´ªå¿ƒçš„å±€éƒ¨æœ€ä¼˜ï¼‰
                    </div>
                `,
                'Graph-Kernel': `
                    <h4>å›¾æ ¸æ–¹æ³•åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1: æå–å±€éƒ¨å­å›¾</strong><br>
                        â€¢ 1-hopå­å›¾ï¼šèŠ‚ç‚¹çš„æ‰€æœ‰é‚»å±…<br>
                        â€¢ 2-hopå­å›¾ï¼šé‚»å±…çš„é‚»å±…
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤2: Weisfeiler-Lehmanæ ¸</strong><br>
                        è¿­ä»£æ›´æ–°èŠ‚ç‚¹æ ‡ç­¾
                    </div>
                    <div class="formula">
                        label'(v) = hash(label(v) + sort([label(u) for u âˆˆ N(v)]))
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤3: æ ¸ç›¸ä¼¼åº¦</strong><br>
                        ç»Ÿè®¡æ ‡ç­¾åˆ†å¸ƒï¼Œè®¡ç®—åˆ†å¸ƒç›¸ä¼¼åº¦
                    </div>
                    <div class="formula">
                        K[i,j] = kernel(subgraph(v_i), subgraph(v'_j))
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤4:</strong> åŸºäºæ ¸çŸ©é˜µè¿›è¡ŒåŒ¹é…
                    </div>
                `,
                'DeepWalk': `
                    <h4>DeepWalkå›¾åµŒå…¥åŸç†</h4>
                    <div class="step">
                        <strong>æ­¥éª¤1: éšæœºæ¸¸èµ°é‡‡æ ·</strong><br>
                        ä»æ¯ä¸ªèŠ‚ç‚¹å¼€å§‹è¿›è¡Œå¤šæ¡éšæœºæ¸¸èµ°ï¼ˆå¦‚20æ¬¡ Ã— 80æ­¥ï¼‰
                    </div>
                    <div class="formula">
                        è·¯å¾„: [v, u1, u2, ..., u_t]
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤2: Skip-gramè®­ç»ƒ</strong><br>
                        å°†èŠ‚ç‚¹åºåˆ—è§†ä¸º"å¥å­"ï¼Œä½¿ç”¨Word2Vecè®­ç»ƒ
                    </div>
                    <div class="formula">
                        max Î£ log P(neighbors(v) | v)
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤3: è·å¾—èŠ‚ç‚¹åµŒå…¥</strong><br>
                        æ¯ä¸ªèŠ‚ç‚¹ â†’ 128ç»´å‘é‡
                    </div>
                    <div class="step">
                        <strong>æ­¥éª¤4: åµŒå…¥ç©ºé—´åŒ¹é…</strong><br>
                        è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•åŒ¹é…
                    </div>
                    <div class="formula">
                        similarity = cos(emb(v_i), emb(v'_j))
                    </div>
                `
            };
            
            const content = principles[methodName] || '<p>æš‚æ— åŸç†è¯´æ˜</p>';
            document.getElementById('principle-content').innerHTML = content;
        }
        
        function showResults(methodData) {
            const resultsDiv = document.getElementById('results-display');
            
            resultsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${(methodData.accuracy * 100).toFixed(1)}%</div>
                        <div class="stat-label">å‡†ç¡®ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(methodData['precision@5'] * 100).toFixed(1)}%</div>
                        <div class="stat-label">P@5</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(methodData['precision@10'] * 100).toFixed(1)}%</div>
                        <div class="stat-label">P@10</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${methodData.mrr.toFixed(3)}</div>
                        <div class="stat-label">MRR</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em;">
                    <strong>ç›¸æ¯”éšæœºåŸºå‡†:</strong><br>
                    æå‡ <span style="color: var(--color-success); font-weight: bold; font-size: 1.2em;">
                        ${methodData.improvement_factor.toFixed(1)}Ã—
                    </span>
                </div>
            `;
        }
        
        function updateBottomViz(methodName, methodData) {
            const bottomDiv = document.getElementById('bottom-viz');
            document.getElementById('bottom-title').textContent = `${methodName} - Top-Kå‡†ç¡®ç‡æ›²çº¿`;
            
            // ç»˜åˆ¶Top-Kæ›²çº¿
            bottomDiv.innerHTML = '<svg id="topk-svg" style="width: 100%; height: 100%;"></svg>';
            
            const svg = d3.select('#topk-svg');
            const container = bottomDiv;
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = {top: 20, right: 30, bottom: 40, left: 50};
            
            const data = Object.entries(methodData.topk_curve).map(([k, acc]) => ({
                k: parseInt(k),
                accuracy: acc
            }));
            
            const xScale = d3.scaleLinear()
                .domain([1, 20])
                .range([margin.left, width - margin.right]);
            
            const yScale = d3.scaleLinear()
                .domain([0, 1])
                .range([height - margin.bottom, margin.top]);
            
            // ç»˜åˆ¶ç½‘æ ¼
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(10).tickSize(-height + margin.top + margin.bottom).tickFormat(''))
                .style('stroke', '#e0e0e0')
                .style('stroke-dasharray', '2,2');
            
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale).ticks(10).tickSize(-width + margin.left + margin.right).tickFormat(''))
                .style('stroke', '#e0e0e0')
                .style('stroke-dasharray', '2,2');
            
            // ç»˜åˆ¶çº¿
            const line = d3.line()
                .x(d => xScale(d.k))
                .y(d => yScale(d.accuracy))
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', 'var(--color-primary)')
                .attr('stroke-width', 3)
                .attr('d', line);
            
            // ç»˜åˆ¶ç‚¹
            svg.selectAll('.dot')
                .data(data)
                .join('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.k))
                .attr('cy', d => yScale(d.accuracy))
                .attr('r', 4)
                .attr('fill', 'var(--color-primary)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 7);
                    showTooltip(event, `Top-${d.k}: ${(d.accuracy * 100).toFixed(1)}%`);
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 4);
                    hideTooltip();
                });
            
            // åæ ‡è½´
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(10))
                .style('font-size', '11px');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale).ticks(10).tickFormat(d => (d * 100).toFixed(0) + '%'))
                .style('font-size', '11px');
            
            // æ ‡ç­¾
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .text('Top-K')
                .style('font-size', '12px')
                .style('font-weight', 'bold');
            
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 15)
                .attr('text-anchor', 'middle')
                .text('å‡†ç¡®ç‡')
                .style('font-size', '12px')
                .style('font-weight', 'bold');
        }
        
        // æ¸²æŸ“ä¸¤ä¸ªå›¾çš„å¯¹æ¯”
        function renderTwoGraphs() {
            if (!DATA || !DATA.graph_data) return;
            
            renderSingleGraph(DATA.graph_data, 'graph-orig-svg', '#2196F3');
            renderSingleGraph(DATA.graph_data, 'graph-anon-svg', '#FF9800');
        }
        
        function renderSingleGraph(graphData, svgId, color) {
            const svg = d3.select('#' + svgId);
            svg.selectAll('*').remove();
            
            const container = svg.node().parentNode;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // åˆ›å»ºç¼©æ”¾è¡Œä¸º
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            const g = svg.append('g');
            
            // åŠ›å¯¼å‘å¸ƒå±€
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges)
                    .id(d => d.index)
                    .distance(30))
                .force('charge', d3.forceManyBody().strength(-80))
                .force('center', d3.forceCenter(width/2, height/2))
                .force('collision', d3.forceCollide().radius(d => Math.max(6, Math.sqrt(d.degree) * 2.5)));
            
            // ç»˜åˆ¶è¾¹
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.edges)
                .join('line')
                .attr('class', 'link');
            
            // ç»˜åˆ¶èŠ‚ç‚¹ - æ›´å¤§çš„èŠ‚ç‚¹
            const node = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', d => Math.max(5, Math.sqrt(d.degree) * 2))  // æ›´å¤§çš„èŠ‚ç‚¹
                .attr('fill', color)
                .on('mouseover', function(event, d) {
                    d3.select(this).classed('highlighted', true);
                    // é«˜äº®è¿æ¥çš„è¾¹
                    link.classed('highlighted', l => 
                        l.source.index === d.index || l.target.index === d.index
                    );
                    showTooltip(event, `èŠ‚ç‚¹ ${d.id}<br>åº¦æ•°: ${d.degree}`);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).classed('highlighted', false);
                    link.classed('highlighted', false);
                    hideTooltip();
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // æ·»åŠ æ ‡ç­¾ï¼ˆä»…å¯¹åº¦æ•°å¤§çš„èŠ‚ç‚¹æ˜¾ç¤ºï¼‰
            const labels = g.append('g')
                .selectAll('text')
                .data(graphData.nodes.filter(d => d.degree > 20))
                .join('text')
                .attr('class', 'node-label')
                .text(d => d.id);
            
            // æ›´æ–°ä½ç½®
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // 3ç§’ååœæ­¢
            setTimeout(() => simulation.stop(), 3000);
            
            // æ‹–æ‹½å‡½æ•°
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // ä¿å­˜å¼•ç”¨
            if (svgId === 'graph-orig-svg') {
                origGraphElements = {nodes: node, links: link, labels: labels};
            } else {
                anonGraphElements = {nodes: node, links: link, labels: labels};
            }
        }
        
        // æç¤ºæ¡†å‡½æ•°
        function showTooltip(event, html) {
            let tooltip = d3.select('.tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div').attr('class', 'tooltip');
            }
            
            tooltip
                .html(html)
                .style('display', 'block')
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }
        
        function hideTooltip() {
            d3.select('.tooltip').style('display', 'none');
        }
        
        // é²æ£’æ€§æµ‹è¯•
        function showRobustness() {
            document.getElementById('principle-content').innerHTML = `
                <h4>é²æ£’æ€§æµ‹è¯•åŸç†</h4>
                <div class="step">
                    æµ‹è¯•åœ¨å›¾æ•°æ®ä¸å®Œæ•´ï¼ˆç¼ºå¤±è¾¹ï¼‰æ—¶ï¼Œæ”»å‡»æ•ˆæœå¦‚ä½•å˜åŒ–
                </div>
                <div class="step">
                    <strong>æµ‹è¯•æ–¹æ³•:</strong><br>
                    â€¢ éšæœºåˆ é™¤ä¸åŒæ¯”ä¾‹çš„è¾¹ï¼ˆ10%, 20%, ..., 50%ï¼‰<br>
                    â€¢ åœ¨ä¸å®Œæ•´å›¾ä¸Šè¿è¡Œæ”»å‡»<br>
                    â€¢ è§‚å¯Ÿå‡†ç¡®ç‡ä¸‹é™è¶‹åŠ¿
                </div>
            `;
            
            document.getElementById('results-display').innerHTML = '<p style="color: #999; text-align: center;">é²æ£’æ€§æµ‹è¯•ç»“æœ</p>';
        }
        
        // å·®åˆ†éšç§é˜²å¾¡
        function showDefense() {
            document.getElementById('principle-content').innerHTML = `
                <h4>å·®åˆ†éšç§é˜²å¾¡åŸç†</h4>
                <div class="step">
                    <strong>Îµ-å·®åˆ†éšç§å®šä¹‰:</strong>
                </div>
                <div class="formula">
                    P(M(G) âˆˆ S) / P(M(G') âˆˆ S) â‰¤ e^Îµ
                </div>
                <div class="step">
                    <strong>è¾¹æ‰°åŠ¨æœºåˆ¶:</strong><br>
                    â€¢ ä»¥æ¦‚ç‡ p = 1/(1+e^Îµ) åˆ é™¤åŸæœ‰è¾¹<br>
                    â€¢ ä»¥æ¦‚ç‡ p = 1/(1+e^Îµ) æ·»åŠ å™ªå£°è¾¹
                </div>
                <div class="step">
                    <strong>éšç§-æ•ˆç”¨æƒè¡¡:</strong><br>
                    â€¢ Îµè¶Šå°ï¼Œéšç§ä¿æŠ¤è¶Šå¼ºï¼Œä½†å›¾æ•ˆç”¨ä¸‹é™<br>
                    â€¢ Îµè¶Šå¤§ï¼Œå›¾æ•ˆç”¨è¶Šå¥½ï¼Œä½†éšç§ä¿æŠ¤è¾ƒå¼±
                </div>
            `;
            
            document.getElementById('results-display').innerHTML = '<p style="color: #999; text-align: center;">å·®åˆ†éšç§é˜²å¾¡æ•ˆæœ</p>';
        }
    </script>
</body>
</html>
